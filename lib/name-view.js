"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const space_pen_1 = require("space-pen");
const atom_space_pen_views_1 = require("atom-space-pen-views");
const atom_1 = require("atom");
class NameView extends space_pen_1.View {
    constructor() {
        super();
        this.nameEditor = null;
        this.nameEditor = this.bundle_name.getModel();
        this.disposables = new atom_1.CompositeDisposable();
        this.on("click", ".buttons .icon-x", (event) => this.cancel(event));
        this.on("click", ".buttons .icon-check", (event) => this.accept(event));
        this.on("click", ".buttons .icon-arrow-left", (event) => this.back(event));
        this.disposables.add(atom.commands.add(this.element, {
            "core:confirm": (event) => this.accept(event),
            "core:cancel": (event) => this.cancel(event),
        }));
    }
    static content() {
        this.div({ class: "nameview" }, () => {
            this.div({ class: "block" }, () => {
                this.label(() => {
                    this.div({ class: "bundle-name" }, "Bundle Name");
                });
                this.subview("bundle_name", new atom_space_pen_views_1.TextEditorView({ mini: true }));
                this.div({ id: "name-error-none", class: "error hidden" }, "This field cannot be empty");
                this.div({ id: "name-error-used", class: "error hidden" }, "Name already used");
            });
            this.div({ class: "block text-subtle" }, () => {
                this.div({ class: "added icon icon-diff-added hidden", outlet: "added" });
                this.div({ class: "removed icon icon-diff-removed hidden", outlet: "removed" });
            });
            this.div({ class: "buttons" }, () => {
                this.div(() => {
                    this.div({ class: "btn btn-error icon icon-x inline-block-tight" }, "Cancel");
                    this.div({ class: " btn btn-error icon icon-arrow-left inline-block-tight" }, "Back");
                });
                this.div({ class: "btn btn-primary icon icon-check inline-block-tight" }, "Accept");
            });
        });
    }
    destroy() {
        this.disposables.dispose();
        this.detach();
        this.panel != null ? this.panel.hide() : undefined;
    }
    cancel(event) {
        if (this.panel != null) {
            this.panel.hide();
        }
        event.stopPropagation();
    }
    back(event) {
        this.backCallback(this.oldname, this.items);
        this.cancel(event);
    }
    accept(event) {
        if (!this.validInput()) {
            if (this.nameEditor.getText() === "") {
                this.find("#name-error-none").removeClass("hidden");
            }
            else {
                this.find("#name-error-used").removeClass("hidden");
            }
        }
        else {
            this.cancel(event);
            this.confirmCallback(this.oldname, this.nameEditor.getText(), this.items);
        }
    }
    validInput() {
        this.clearErrors();
        return (this.nameEditor.getText() !== "" &&
            (this.oldname != null || this.bundles.getBundle(this.nameEditor.getText()) == null));
    }
    clearErrors() {
        this.find("#name-error-none").addClass("hidden");
        this.find("#name-error-used").addClass("hidden");
    }
    clearPackages() {
        this.added.addClass("hidden");
        this.removed.addClass("hidden");
    }
    showPackages(div, packages) {
        div.removeClass("hidden");
        div.html(packages.toString());
    }
    show(bundles, oldname, items, { confirmCallback, backCallback }) {
        this.bundles = bundles;
        this.oldname = oldname;
        this.items = items;
        this.confirmCallback = confirmCallback;
        this.backCallback = backCallback;
        if (this.oldname != null) {
            this.nameEditor.setText(this.oldname);
        }
        else {
            this.nameEditor.setText("");
        }
        this.clearErrors();
        this.clearPackages();
        const items_added = [];
        const items_removed = [];
        this.items.forEach(function (item) {
            if (item.action === "added") {
                items_added.push(item.name);
            }
            else {
                items_removed.push(item.name);
            }
        });
        if (items_added.length !== 0) {
            this.showPackages(this.added, items_added);
        }
        if (items_removed.length !== 0) {
            this.showPackages(this.removed, items_removed);
        }
        if (this.panel == null) {
            this.panel = atom.workspace.addModalPanel({ item: this });
        }
        this.panel.show();
        this.bundle_name.focus();
    }
}
exports.NameView = NameView;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmFtZS12aWV3LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL25hbWUtdmlldy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUtBLHlDQUFnQztBQUNoQywrREFBcUQ7QUFDckQsK0JBQTBDO0FBRTFDLE1BQWEsUUFBUyxTQUFRLGdCQUFJO0lBMkJoQztRQUNFLEtBQUssRUFBRSxDQUFBO1FBM0JULGVBQVUsR0FBRyxJQUFJLENBQUE7UUE0QmYsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsRUFBRSxDQUFBO1FBRTdDLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSwwQkFBbUIsRUFBRSxDQUFBO1FBRTVDLElBQUksQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLGtCQUFrQixFQUFFLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUE7UUFDbkUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQTtRQUN2RSxJQUFJLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSwyQkFBMkIsRUFBRSxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFBO1FBRTFFLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUNsQixJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFO1lBQzlCLGNBQWMsRUFBRSxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUM7WUFDN0MsYUFBYSxFQUFFLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUss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QzlCO1FBQ0gsQ0FBQyxDQUFDLENBQUE7UUFDRixJQUFJLFdBQVcsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1lBQzVCLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxXQUFXLENBQUMsQ0FBQTtTQUMzQztRQUNELElBQUksYUFBYSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7WUFDOUIsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLGFBQWEsQ0FBQyxDQUFBO1NBQy9DO1FBRUQsSUFBSSxJQUFJLENBQUMsS0FBSyxJQUFJLElBQUksRUFBRTtZQUN0QixJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsYUFBYSxDQUFDLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUE7U0FDMUQ7UUFDRCxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFBO1FBQ2pCLElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxFQUFFLENBQUE7SUFDMUIsQ0FBQztDQUNGO0FBdElELDRCQXNJQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXHJcbiAqIGRlY2FmZmVpbmF0ZSBzdWdnZXN0aW9uczpcclxuICogRFMyMDc6IENvbnNpZGVyIHNob3J0ZXIgdmFyaWF0aW9ucyBvZiBudWxsIGNoZWNrc1xyXG4gKiBGdWxsIGRvY3M6IGh0dHBzOi8vZ2l0aHViLmNvbS9kZWNhZmZlaW5hdGUvZGVjYWZmZWluYXRlL2Jsb2IvbWFzdGVyL2RvY3Mvc3VnZ2VzdGlvbnMubWRcclxuICovXHJcbmltcG9ydCB7IFZpZXcgfSBmcm9tIFwic3BhY2UtcGVuXCJcclxuaW1wb3J0IHsgVGV4dEVkaXRvclZpZXcgfSBmcm9tIFwiYXRvbS1zcGFjZS1wZW4tdmlld3NcIlxyXG5pbXBvcnQgeyBDb21wb3NpdGVEaXNwb3NhYmxlIH0gZnJvbSBcImF0b21cIlxyXG5cclxuZXhwb3J0IGNsYXNzIE5hbWVWaWV3IGV4dGVuZHMgVmlldyB7XHJcbiAgbmFtZUVkaXRvciA9IG51bGxcclxuXHJcbiAgc3RhdGljIGNvbnRlbnQoKSB7XHJcbiAgICB0aGlzLmRpdih7IGNsYXNzOiBcIm5hbWV2aWV3XCIgfSwgKCkgPT4ge1xyXG4gICAgICB0aGlzLmRpdih7IGNsYXNzOiBcImJsb2NrXCIgfSwgKCkgPT4ge1xyXG4gICAgICAgIHRoaXMubGFiZWwoKCkgPT4ge1xyXG4gICAgICAgICAgdGhpcy5kaXYoeyBjbGFzczogXCJidW5kbGUtbmFtZVwiIH0sIFwiQnVuZGxlIE5hbWVcIilcclxuICAgICAgICB9KVxyXG4gICAgICAgIHRoaXMuc3VidmlldyhcImJ1bmRsZV9uYW1lXCIsIG5ldyBUZXh0RWRpdG9yVmlldyh7IG1pbmk6IHRydWUgfSkpXHJcbiAgICAgICAgdGhpcy5kaXYoeyBpZDogXCJuYW1lLWVycm9yLW5vbmVcIiwgY2xhc3M6IFwiZXJyb3IgaGlkZGVuXCIgfSwgXCJUaGlzIGZpZWxkIGNhbm5vdCBiZSBlbXB0eVwiKVxyXG4gICAgICAgIHRoaXMuZGl2KHsgaWQ6IFwibmFtZS1lcnJvci11c2VkXCIsIGNsYXNzOiBcImVycm9yIGhpZGRlblwiIH0sIFwiTmFtZSBhbHJlYWR5IHVzZWRcIilcclxuICAgICAgfSlcclxuICAgICAgdGhpcy5kaXYoeyBjbGFzczogXCJibG9jayB0ZXh0LXN1YnRsZVwiIH0sICgpID0+IHtcclxuICAgICAgICB0aGlzLmRpdih7IGNsYXNzOiBcImFkZGVkIGljb24gaWNvbi1kaWZmLWFkZGVkIGhpZGRlblwiLCBvdXRsZXQ6IFwiYWRkZWRcIiB9KVxyXG4gICAgICAgIHRoaXMuZGl2KHsgY2xhc3M6IFwicmVtb3ZlZCBpY29uIGljb24tZGlmZi1yZW1vdmVkIGhpZGRlblwiLCBvdXRsZXQ6IFwicmVtb3ZlZFwiIH0pXHJcbiAgICAgIH0pXHJcbiAgICAgIHRoaXMuZGl2KHsgY2xhc3M6IFwiYnV0dG9uc1wiIH0sICgpID0+IHtcclxuICAgICAgICB0aGlzLmRpdigoKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLmRpdih7IGNsYXNzOiBcImJ0biBidG4tZXJyb3IgaWNvbiBpY29uLXggaW5saW5lLWJsb2NrLXRpZ2h0XCIgfSwgXCJDYW5jZWxcIilcclxuICAgICAgICAgIHRoaXMuZGl2KHsgY2xhc3M6IFwiIGJ0biBidG4tZXJyb3IgaWNvbiBpY29uLWFycm93LWxlZnQgaW5saW5lLWJsb2NrLXRpZ2h0XCIgfSwgXCJCYWNrXCIpXHJcbiAgICAgICAgfSlcclxuICAgICAgICB0aGlzLmRpdih7IGNsYXNzOiBcImJ0biBidG4tcHJpbWFyeSBpY29uIGljb24tY2hlY2sgaW5saW5lLWJsb2NrLXRpZ2h0XCIgfSwgXCJBY2NlcHRcIilcclxuICAgICAgfSlcclxuICAgIH0pXHJcbiAgfVxyXG5cclxuICBjb25zdHJ1Y3RvcigpIHtcclxuICAgIHN1cGVyKClcclxuICAgIHRoaXMubmFtZUVkaXRvciA9IHRoaXMuYnVuZGxlX25hbWUuZ2V0TW9kZWwoKVxyXG5cclxuICAgIHRoaXMuZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXHJcblxyXG4gICAgdGhpcy5vbihcImNsaWNrXCIsIFwiLmJ1dHRvbnMgLmljb24teFwiLCAoZXZlbnQpID0+IHRoaXMuY2FuY2VsKGV2ZW50KSlcclxuICAgIHRoaXMub24oXCJjbGlja1wiLCBcIi5idXR0b25zIC5pY29uLWNoZWNrXCIsIChldmVudCkgPT4gdGhpcy5hY2NlcHQoZXZlbnQpKVxyXG4gICAgdGhpcy5vbihcImNsaWNrXCIsIFwiLmJ1dHRvbnMgLmljb24tYXJyb3ctbGVmdFwiLCAoZXZlbnQpID0+IHRoaXMuYmFjayhldmVudCkpXHJcblxyXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoXHJcbiAgICAgIGF0b20uY29tbWFuZHMuYWRkKHRoaXMuZWxlbWVudCwge1xyXG4gICAgICAgIFwiY29yZTpjb25maXJtXCI6IChldmVudCkgPT4gdGhpcy5hY2NlcHQoZXZlbnQpLFxyXG4gICAgICAgIFwiY29yZTpjYW5jZWxcIjogKGV2ZW50KSA9PiB0aGlzLmNhbmNlbChldmVudCksXHJcbiAgICAgIH0pXHJcbiAgICApXHJcbiAgfVxyXG5cclxuICBkZXN0cm95KCkge1xyXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5kaXNwb3NlKClcclxuICAgIHRoaXMuZGV0YWNoKClcclxuICAgIHRoaXMucGFuZWwgIT0gbnVsbCA/IHRoaXMucGFuZWwuaGlkZSgpIDogdW5kZWZpbmVkXHJcbiAgfVxyXG5cclxuICBjYW5jZWwoZXZlbnQ/KSB7XHJcbiAgICBpZiAodGhpcy5wYW5lbCAhPSBudWxsKSB7XHJcbiAgICAgIHRoaXMucGFuZWwuaGlkZSgpXHJcbiAgICB9XHJcbiAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKVxyXG4gIH1cclxuXHJcbiAgYmFjayhldmVudD8pIHtcclxuICAgIHRoaXMuYmFja0NhbGxiYWNrKHRoaXMub2xkbmFtZSwgdGhpcy5pdGVtcylcclxuICAgIHRoaXMuY2FuY2VsKGV2ZW50KVxyXG4gIH1cclxuXHJcbiAgYWNjZXB0KGV2ZW50Pykge1xyXG4gICAgaWYgKCF0aGlzLnZhbGlkSW5wdXQoKSkge1xyXG4gICAgICBpZiAodGhpcy5uYW1lRWRpdG9yLmdldFRleHQoKSA9PT0gXCJcIikge1xyXG4gICAgICAgIHRoaXMuZmluZChcIiNuYW1lLWVycm9yLW5vbmVcIikucmVtb3ZlQ2xhc3MoXCJoaWRkZW5cIilcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB0aGlzLmZpbmQoXCIjbmFtZS1lcnJvci11c2VkXCIpLnJlbW92ZUNsYXNzKFwiaGlkZGVuXCIpXHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMuY2FuY2VsKGV2ZW50KVxyXG4gICAgICB0aGlzLmNvbmZpcm1DYWxsYmFjayh0aGlzLm9sZG5hbWUsIHRoaXMubmFtZUVkaXRvci5nZXRUZXh0KCksIHRoaXMuaXRlbXMpXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICB2YWxpZElucHV0KCkge1xyXG4gICAgdGhpcy5jbGVhckVycm9ycygpXHJcbiAgICByZXR1cm4gKFxyXG4gICAgICB0aGlzLm5hbWVFZGl0b3IuZ2V0VGV4dCgpICE9PSBcIlwiICYmXHJcbiAgICAgICh0aGlzLm9sZG5hbWUgIT0gbnVsbCB8fCB0aGlzLmJ1bmRsZXMuZ2V0QnVuZGxlKHRoaXMubmFtZUVkaXRvci5nZXRUZXh0KCkpID09IG51bGwpXHJcbiAgICApXHJcbiAgfVxyXG5cclxuICBjbGVhckVycm9ycygpIHtcclxuICAgIHRoaXMuZmluZChcIiNuYW1lLWVycm9yLW5vbmVcIikuYWRkQ2xhc3MoXCJoaWRkZW5cIilcclxuICAgIHRoaXMuZmluZChcIiNuYW1lLWVycm9yLXVzZWRcIikuYWRkQ2xhc3MoXCJoaWRkZW5cIilcclxuICB9XHJcblxyXG4gIGNsZWFyUGFja2FnZXMoKSB7XHJcbiAgICB0aGlzLmFkZGVkLmFkZENsYXNzKFwiaGlkZGVuXCIpXHJcbiAgICB0aGlzLnJlbW92ZWQuYWRkQ2xhc3MoXCJoaWRkZW5cIilcclxuICB9XHJcblxyXG4gIHNob3dQYWNrYWdlcyhkaXYsIHBhY2thZ2VzKSB7XHJcbiAgICBkaXYucmVtb3ZlQ2xhc3MoXCJoaWRkZW5cIilcclxuICAgIGRpdi5odG1sKHBhY2thZ2VzLnRvU3RyaW5nKCkpXHJcbiAgfVxyXG5cclxuICBzaG93KGJ1bmRsZXMsIG9sZG5hbWUsIGl0ZW1zLCB7IGNvbmZpcm1DYWxsYmFjaywgYmFja0NhbGxiYWNrIH0pIHtcclxuICAgIHRoaXMuYnVuZGxlcyA9IGJ1bmRsZXNcclxuICAgIHRoaXMub2xkbmFtZSA9IG9sZG5hbWVcclxuICAgIHRoaXMuaXRlbXMgPSBpdGVtc1xyXG4gICAgdGhpcy5jb25maXJtQ2FsbGJhY2sgPSBjb25maXJtQ2FsbGJhY2tcclxuICAgIHRoaXMuYmFja0NhbGxiYWNrID0gYmFja0NhbGxiYWNrXHJcbiAgICBpZiAodGhpcy5vbGRuYW1lICE9IG51bGwpIHtcclxuICAgICAgdGhpcy5uYW1lRWRpdG9yLnNldFRleHQodGhpcy5vbGRuYW1lKVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5uYW1lRWRpdG9yLnNldFRleHQoXCJcIilcclxuICAgIH1cclxuICAgIHRoaXMuY2xlYXJFcnJvcnMoKVxyXG4gICAgdGhpcy5jbGVhclBhY2thZ2VzKClcclxuICAgIGNvbnN0IGl0ZW1zX2FkZGVkID0gW11cclxuICAgIGNvbnN0IGl0ZW1zX3JlbW92ZWQgPSBbXVxyXG4gICAgdGhpcy5pdGVtcy5mb3JFYWNoKGZ1bmN0aW9uIChpdGVtKSB7XHJcbiAgICAgIGlmIChpdGVtLmFjdGlvbiA9PT0gXCJhZGRlZFwiKSB7XHJcbiAgICAgICAgaXRlbXNfYWRkZWQucHVzaChpdGVtLm5hbWUpXHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgaXRlbXNfcmVtb3ZlZC5wdXNoKGl0ZW0ubmFtZSlcclxuICAgICAgfVxyXG4gICAgfSlcclxuICAgIGlmIChpdGVtc19hZGRlZC5sZW5ndGggIT09IDApIHtcclxuICAgICAgdGhpcy5zaG93UGFja2FnZXModGhpcy5hZGRlZCwgaXRlbXNfYWRkZWQpXHJcbiAgICB9XHJcbiAgICBpZiAoaXRlbXNfcmVtb3ZlZC5sZW5ndGggIT09IDApIHtcclxuICAgICAgdGhpcy5zaG93UGFja2FnZXModGhpcy5yZW1vdmVkLCBpdGVtc19yZW1vdmVkKVxyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLnBhbmVsID09IG51bGwpIHtcclxuICAgICAgdGhpcy5wYW5lbCA9IGF0b20ud29ya3NwYWNlLmFkZE1vZGFsUGFuZWwoeyBpdGVtOiB0aGlzIH0pXHJcbiAgICB9XHJcbiAgICB0aGlzLnBhbmVsLnNob3coKVxyXG4gICAgdGhpcy5idW5kbGVfbmFtZS5mb2N1cygpXHJcbiAgfVxyXG59XHJcbiJdfQ==