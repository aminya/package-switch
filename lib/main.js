"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var t=require("atom"),a=e(require("fs")),i=e(require("path")),n=require("atom-space-pen-views"),s=function(e,t){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var a in t)t.hasOwnProperty(a)&&(e[a]=t[a])})(e,t)};function o(e,t){function a(){this.constructor=e}s(e,t),e.prototype=null===t?Object.create(t):(a.prototype=t.prototype,new a)}var c,r,l,d,u,p,h,f=require("space-pen").View,g=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return o(t,e),t.content=function(){var e=this;this.div({class:"package-switch",tabindex:-1},(function(){e.div({class:"inset-panel"},(function(){e.div({class:"panel-heading icon icon-book"},(function(){e.span({outlet:"name"}),e.span({class:"inline-block btn-group"},(function(){e.button({class:"btn btn-xs"},"Execute"),e.button({class:"opposite btn btn-xs"},"Execute Opposite")}))})),e.div({class:"panel-body padded"},(function(){e.div({class:"package-list",outlet:"package_list"})}))}))}))},t.prototype.initialize=function(e){var t=this,a=e.uri,i=e.file;this.uri=a,this.file=i,this.find(".btn").on("click",(function(e){var a=e.currentTarget;t.save(),t.file.execute(a.classList.contains("opposite"))})),this.updateContent()},t.prototype.destroy=function(){this.save()},t.prototype.getURI=function(){return this.uri},t.prototype.getTitle=function(){return"Package Switch Settings"},t.prototype.getIconName=function(){return"tools"},t.prototype.updateContent=function(){var e,t=this;this.name.text(this.file.name);for(var a={},i=0,n=this.file.packages;i<n.length;i++)a[(e=n[i]).name]=e.action;for(var s=0,o=atom.packages.getAvailablePackageNames();s<o.length;s++)null==a[e=o[s]]&&(a[e]="ignored");for(var c=[],r=0,l=Object.keys(a);r<l.length;r++){var d=l[r];c.push({name:d,action:a[d]})}this.package_list.text(""),c.map((function(e){return t.addPackage(e)}))},t.prototype.addPackage=function(e){var t,a=e.name,i=e.action,n=(t=function(){var e=this;this.div({class:"package"},(function(){e.div({class:"item icon icon-diff-"+i},a)}))},f.render.call(f,t));n.on("click",(function(e){var t=e.currentTarget.children[0];t.classList.contains("icon-diff-added")?(t.classList.remove("icon-diff-added"),t.classList.add("icon-diff-removed")):t.classList.contains("icon-diff-ignored")?(t.classList.remove("icon-diff-ignored"),t.classList.add("icon-diff-added")):(t.classList.remove("icon-diff-removed"),t.classList.add("icon-diff-ignored"))})),this.package_list.append(n)},t.prototype.save=function(){this.file.packages=[];for(var e=0,t=Array.from(this.package_list.children());e<t.length;e++){var a=t[e];a.children[0].classList.contains("icon-diff-added")&&this.file.packages.push({name:a.children[0].innerText,action:"added"}),a.children[0].classList.contains("icon-diff-removed")&&this.file.packages.push({name:a.children[0].innerText,action:"removed"})}this.file.save()},t}(f),m=function(){function e(e,t){if(this.name=e,this.filepath=t,a.existsSync(this.filepath))try{this.packages=JSON.parse(a.readFileSync(this.filepath)),null==this.packages&&(this.packages=[])}catch(e){atom.notifications.addError(e)}else this.packages=[]}return e.prototype.execute=function(e){this.packages.map((function(t){return e?"removed"===t.action?atom.packages.enablePackage(t.name):atom.packages.disablePackage(t.name):"added"===t.action?atom.packages.enablePackage(t.name):atom.packages.disablePackage(t.name)}))},e.prototype.save=function(){try{a.writeFileSync(this.filepath,JSON.stringify(this.packages,null,"\t"))}catch(e){atom.notifications.addError(e)}},e}(),k=function(){function e(e,t){atom.notifications.addWarning("Using CSON config for package-switch is deprecated. \n    Convert "+t+" to JSON at https://decaffeinate-project.org/repl/"),new Promise((function(e){e(require("./cson-da62047d.js"))})).then((function(e){c=e})),this.name=e,this.filepath=t;try{this.packages=c.readFileSync(this.filepath),null==this.packages&&(this.packages=[])}catch(e){this.packages=[]}}return e.prototype.execute=function(e){this.packages.map((function(t){return e?"removed"===t.action?atom.packages.enablePackage(t.name):atom.packages.disablePackage(t.name):"added"===t.action?atom.packages.enablePackage(t.name):atom.packages.disablePackage(t.name)}))},e.prototype.save=function(){try{c.writeFileSync(this.filepath,this.packages)}catch(e){}},e}(),v=require("space-pen").View,b=require("jquery"),y=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return o(t,e),t.prototype.initialize=function(){return e.prototype.initialize.apply(this,arguments)},t.prototype.viewForItem=function(e){var t,a=e.name,i=e.action;return t=function(){var e=this;return this.li((function(){return e.div({class:"status-"+i+" icon icon-diff-"+i},a)}))},v.render.call(v,t)},t.prototype.confirmed=function(){return this.isDisabled()?this.setNeutral():this.isNeutral()?this.setEnabled():this.setDisabled()},t.prototype.cancel=function(){var t=[];if(this.items.forEach((function(e){if("ignored"!==e.action)return t.push(e)})),e.prototype.cancel.apply(this,arguments),null!=this.panel&&this.panel.hide(),0!==t.length)return this.cb(this.oldname,t)},t.prototype.show=function(e,t){var a;void 0===e&&(e=null),this.cb=t,null==this.panel&&(this.panel=atom.workspace.addModalPanel({item:this})),this.panel.show(),null!=e?(this.oldname=e.name,a=e.packages):(this.oldname=null,a=[]);var i=[];return atom.packages.getAvailablePackageNames().forEach((function(e){var t=a.filter((function(t){return t.name===e}));return null==(t=null!=t[0]?t[0].action:void 0)&&(t="ignored"),i.push({name:e,action:t})})),this.setItems(i),this.focusFilterEditor()},t.prototype.populateList=function(t){if(void 0===t&&(t=null),!t)return e.prototype.populateList.apply(this,arguments);var a=b(this.viewForItem(t.data("select-list-item")));a.data("select-list-item",t.data("select-list-item"));for(var i=0;i<this.items.length;i++){var n=this.items[i];if(n.name===t.data("select-list-item").name){this.items[i].action=t.data("select-list-item").action;break}}return t.replaceWith(a),this.selectItemView(a)},t.prototype.getFilterKey=function(){return"name"},t.prototype.isDisabled=function(){return"removed"===this.getSelectedItemView().data("select-list-item").action},t.prototype.isNeutral=function(){return"ignored"===this.getSelectedItemView().data("select-list-item").action},t.prototype.isEnabled=function(){return"added"===this.getSelectedItemView().data("select-list-item").action},t.prototype.setNeutral=function(){var e=this.getSelectedItemView();return e.data("select-list-item").action="ignored",this.populateList(e)},t.prototype.setEnabled=function(){var e=this.getSelectedItemView();return e.data("select-list-item").action="added",this.populateList(e)},t.prototype.setDisabled=function(){var e=this.getSelectedItemView();return e.data("select-list-item").action="removed",this.populateList(e)},t}(n.SelectListView),w=require("space-pen").View,P=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return o(t,e),t.prototype.initialize=function(){return e.prototype.initialize.apply(this,arguments)},t.prototype.viewForItem=function(e){var t,a=e.name,i=e.actions;return t=function(){var e=this;return this.li({class:"two-lines"},(function(){return e.div({class:"primary-line"},a),e.div({class:"secondary-line"},(function(){return e.div({class:"added"},(function(){if(0!==i.added.length)return e.span({class:"icon icon-diff-added"},i.added.toString())})),e.div({class:"removed"},(function(){if(0!==i.removed.length)return e.span({class:"icon icon-diff-removed"},i.removed.toString())}))}))}))},w.render.call(w,t)},t.prototype.confirmed=function(e){return this.cancel(),this.cb(e)},t.prototype.cancelled=function(){return null!=this.panel?this.panel.hide():void 0},t.prototype.show=function(e,t,a){return void 0===a&&(a=!1),this.cb=t,null==this.panel&&(this.panel=atom.workspace.addModalPanel({item:this})),this.panel.show(),e.forEach((function(t,i){t.actions={added:[],removed:[]};for(var n=0,s=t.packages;n<s.length;n++){var o=s[n];a?"removed"===o.action?t.actions.added.push(o.name):t.actions.removed.push(o.name):"added"===o.action?t.actions.added.push(o.name):t.actions.removed.push(o.name)}return e[i]=t})),this.setItems(e),this.focusFilterEditor()},t.prototype.getFilterKey=function(){return"name"},t}(n.SelectListView),S=function(e){function a(){var a=e.call(this)||this;return a.nameEditor=null,a.nameEditor=a.bundle_name.getModel(),a.disposables=new t.CompositeDisposable,a.on("click",".buttons .icon-x",(function(e){return a.cancel(e)})),a.on("click",".buttons .icon-check",(function(e){return a.accept(e)})),a.on("click",".buttons .icon-arrow-left",(function(e){return a.back(e)})),a.disposables.add(atom.commands.add(a.element,{"core:confirm":function(e){return a.accept(e)},"core:cancel":function(e){return a.cancel(e)}})),a}return o(a,e),a.content=function(){var e=this;this.div({class:"nameview"},(function(){e.div({class:"block"},(function(){e.label((function(){e.div({class:"bundle-name"},"Bundle Name")})),e.subview("bundle_name",new n.TextEditorView({mini:!0})),e.div({id:"name-error-none",class:"error hidden"},"This field cannot be empty"),e.div({id:"name-error-used",class:"error hidden"},"Name already used")})),e.div({class:"block text-subtle"},(function(){e.div({class:"added icon icon-diff-added hidden",outlet:"added"}),e.div({class:"removed icon icon-diff-removed hidden",outlet:"removed"})})),e.div({class:"buttons"},(function(){e.div((function(){e.div({class:"btn btn-error icon icon-x inline-block-tight"},"Cancel"),e.div({class:" btn btn-error icon icon-arrow-left inline-block-tight"},"Back")})),e.div({class:"btn btn-primary icon icon-check inline-block-tight"},"Accept")}))}))},a.prototype.destroy=function(){this.disposables.dispose(),this.detach(),null!=this.panel&&this.panel.hide()},a.prototype.cancel=function(e){null!=this.panel&&this.panel.hide(),e.stopPropagation()},a.prototype.back=function(e){this.backCallback(this.oldname,this.items),this.cancel(e)},a.prototype.accept=function(e){this.validInput()?(this.cancel(e),this.confirmCallback(this.oldname,this.nameEditor.getText(),this.items)):""===this.nameEditor.getText()?this.find("#name-error-none").removeClass("hidden"):this.find("#name-error-used").removeClass("hidden")},a.prototype.validInput=function(){return this.clearErrors(),""!==this.nameEditor.getText()&&(null!=this.oldname||null==this.bundles.getBundle(this.nameEditor.getText()))},a.prototype.clearErrors=function(){this.find("#name-error-none").addClass("hidden"),this.find("#name-error-used").addClass("hidden")},a.prototype.clearPackages=function(){this.added.addClass("hidden"),this.removed.addClass("hidden")},a.prototype.showPackages=function(e,t){e.removeClass("hidden"),e.html(t.toString())},a.prototype.show=function(e,t,a,i){var n=i.confirmCallback,s=i.backCallback;this.bundles=e,this.oldname=t,this.items=a,this.confirmCallback=n,this.backCallback=s,null!=this.oldname?this.nameEditor.setText(this.oldname):this.nameEditor.setText(""),this.clearErrors(),this.clearPackages();var o=[],c=[];this.items.forEach((function(e){"added"===e.action?o.push(e.name):c.push(e.name)})),0!==o.length&&this.showPackages(this.added,o),0!==c.length&&this.showPackages(this.removed,c),null==this.panel&&(this.panel=atom.workspace.addModalPanel({item:this})),this.panel.show(),this.bundle_name.focus()},a}(require("space-pen").View),x=function(){function e(e){var t=e.packages;this.packages=t}return e.prototype.execute=function(e){this.packages.map((function(t){return e?"removed"===t.action?atom.packages.enablePackage(t.name):atom.packages.disablePackage(t.name):"added"===t.action?atom.packages.enablePackage(t.name):atom.packages.disablePackage(t.name)}))},e}(),j=function(){function e(e){this.filename=null,this.data={},this.single_bundles={},this.project_bundles={},this.writing=!1,this.reload=this.reload.bind(this),this.setData=this.setData.bind(this),e?this.filename=""===e?null:e:this.getFileName(),null!=this.filename?(this.touchFile(),this.getData(),this.watcher=a.watch(this.filename,this.reload)):this.data={},this.getPackages(),this.project_bundles={},this.emitter=new t.Emitter}return e.prototype.destroy=function(){null!=this.watcher&&this.watcher.close(),this.emitter.dispose(),this.data={},this.single_bundles={},this.project_bundles={}},e.prototype.reload=function(e,t){this.writing?this.writing=!1:(null!=this.filename&&this.getData(),this.emitter.emit("file-change"))},e.prototype.getFileName=function(){var e=atom.config.getUserConfigPath();e||(e=atom.project.getPaths()[0]),this.filename=i.join(i.dirname(e),"package-switch.bundles")},e.prototype.onFileChange=function(e){this.emitter.on("file-change",e)},e.prototype.getData=function(){var e=this;try{var t=JSON.parse(a.readFileSync(this.filename));Object.keys(t).forEach((function(a){e.data[a]=new x(t[a])}))}catch(e){this.notify("Error while reading settings from file")}},e.prototype.getPackages=function(){var e=this;atom.packages.getAvailablePackageNames().forEach((function(t){e.single_bundles[t]=new x({packages:[{name:t,action:"added"}]})}))},e.prototype.setData=function(e){if(void 0===e&&(e=!0),null!=this.filename)try{this.writing=!0,a.writeFileSync(this.filename,JSON.stringify(this.data,null,"\t")),e&&this.emitter.emit("file-change")}catch(e){this.notify("Settings could not be written to "+this.filename),atom.notifications.addError(e)}else this.reload()},e.prototype.notify=function(e){null!=atom.notifications&&atom.notifications.addError(e),console.log("package-switch: "+e)},e.prototype.touchFile=function(){a.existsSync(this.filename)||a.writeFileSync(this.filename,"{}")},e.prototype.addBundle=function(e,t){null!=this.data[e]?this.notify('Bundle "'+e+'" already exists'):(this.data[e]=new x({packages:t}),this.setData())},e.prototype.replaceBundle=function(e,t,a){e===t&&null!=this.data[e]||null!=this.data[e]&&null==this.data[t]?(delete this.data[e],this.data[t]=new x({packages:a}),this.setData()):(this.data[e]||this.notify('Bundle "'+e+'" not found'),null!=this.data[t]&&this.notify('Bundle "'+t+'" already exists'))},e.prototype.removeBundle=function(e){delete this.data[e],this.setData()},e.prototype.getBundle=function(e){var t;return null!=(t=this.project_bundles[e])?t:null!=this.data[e]?this.data[e]:this.single_bundles[e]},e.prototype.getBundles=function(e){var t=this;void 0===e&&(e=!0);var n=[];if(this.project_bundles={},Object.keys(this.data).forEach((function(e){return n.push({name:e,packages:t.data[e].packages})})),!e)return n;for(var s=0,o=atom.project.getPaths();s<o.length;s++){var c=o[s],r=i.join(c,".package-switch.json");if(a.existsSync(r)){var l=void 0,d=void 0;0!==(d=new m(l=i.basename(c),r)).packages.length&&(n.push({name:"Project: "+l,packages:d.packages}),this.project_bundles["Project: "+l]=d)}else{var u=i.join(c,".package-switch.json");if(a.existsSync(u)){l=void 0,d=void 0;0!==(d=new k(l=i.basename(c),r)).packages.length&&(n.push({name:"Project: "+l,packages:d.packages}),this.project_bundles["Project: "+l]=d)}}}return Object.keys(this.single_bundles).forEach((function(e){if(null==t.data[e])return n.push({name:e,packages:t.single_bundles[e].packages})})),n},e}();function E(){d||(d=new P)}function D(){r||(r=new j)}function _(e){void 0===e&&(e=!1),D(),E(),d.show(r.getBundles(),(function(t){!function(e,t){var a,i;a=r.getBundle(t.name),i=function(t){return t.execute(e)},null!=a&&i(a)}(e,t)}),e)}function C(e,t){u||(u=new S),u.show(r,e,t,{confirmCallback:function(e,t,a){!function(e,t,a){null!=e?r.replaceBundle(e,t,a):r.addBundle(t,a)}(e,t,a)},backCallback:function(e,t){return I({name:e,packages:t})}})}function I(e){void 0===e&&(e=null),D(),l||(l=new y),l.show(e,(function(e,t){return C(e,t)}))}exports.activate=function(){!function(){var e=atom.project.getPaths();if(1===e.length){var t=i.join(e[0],".package-switch.json");a.stat(t,(function(a,n){a&&!n&&(atom.packages.activatePackage("tree-view"),atom.packages.activatePackage("tabs"),atom.packages.activatePackage("settings-view"),atom.packages.activatePackage("command-palette")),setTimeout((function(){return new m(i.basename(e[0]),t).execute(!1)}),atom.config.get("package-switch.DeferInitialization"))}));var n=i.join(e[0],".package-switch.cson");a.existsSync(n)&&a.stat(n,(function(t,a){t&&!a&&(atom.packages.activatePackage("tree-view"),atom.packages.activatePackage("tabs"),atom.packages.activatePackage("settings-view"),atom.packages.activatePackage("command-palette")),setTimeout((function(){return new k(i.basename(e[0]),n).execute(!1)}),atom.config.get("package-switch.DeferInitialization"))}))}else atom.packages.activatePackage("tree-view"),atom.packages.activatePackage("tabs"),atom.packages.activatePackage("settings-view"),atom.packages.activatePackage("command-palette")}(),(h=new t.CompositeDisposable).add(atom.commands.add("atom-workspace",{"package-switch:start-packages":function(){return _()},"package-switch:stop-packages":function(){return _(!0)},"package-switch:create":function(){return I()},"package-switch:edit":function(){return D(),E(),void d.show(r.getBundles(!1),(function(e){return I(e)}))},"package-switch:remove":function(){return D(),E(),void d.show(r.getBundles(!1),(function(e){return function(e){r.removeBundle(e.name)}(e)}))},"package-switch:open-global":function(){atom.workspace.open(i.join(i.dirname(atom.config.getUserConfigPath()),"package-switch.bundles"))}}),atom.commands.add('.tree-view .file .name[data-name$="\\.package-switch\\.json"]',"package-switch:open-local",(function(e){var t=e.target;return atom.workspace.open(t.dataset.path,{noopener:!0})})),atom.config.onDidChange("package-switch.SaveRestore",(function(e){e.newValue&&atom.config.set("package-switch.SaveData",atom.config.get("core.disabledPackages").filter((function(e,t,a){return a.indexOf(e)===t})))})),atom.workspace.addOpener((function(e,t){null==t.noopener&&(e.endsWith(".package-switch.json")?p=new g({uri:e,file:new m(i.dirname(e),e)}):e.endsWith(".package-switch.cson")&&(console.error("here"),p=new g({uri:e,file:new k(i.dirname(e),e)})))})))},exports.config={SaveRestore:{title:"Save and restore packages",description:"Restore package states when deactivating this package (e.g. when closing Atom)",type:"boolean",default:!1},SaveData:{title:"Package States",description:"Array of packages to disable when deactivating this package",type:"array",default:[]},DeferInitialization:{title:"Activation Timeout",description:"Number of milliseconds to defer execution of local bundles",type:"integer",default:100},InvertSaveData:{title:"Invert Package States",description:'Disable ALL packages EXCEPT those in "Package States". This includes core packages like tabs, tree-view and settings-view!!!',type:"boolean",default:!1},DisableLanguagePackages:{title:"Do not disable Language Packages",description:'Do not disable language packages. Only if "Invert Package States" is checked',type:"boolean",default:!1}},exports.deactivate=function(){if(atom.config.get("package-switch.SaveRestore")){if(atom.config.get("package-switch.InvertSaveData")){for(var e=atom.config.get("package-switch.DisableLanguagePackages"),t=atom.config.get("package-switch.SaveData"),a=[],i=0,n=atom.packages.getAvailablePackageNames();i<n.length;i++){var s=n[i];"package-switch"!==s&&(t.includes(s)||e&&s.startsWith("language-")||a.push(s))}atom.config.set("core.disabledPackages",a)}else atom.config.set("core.disabledPackages",atom.config.get("package-switch.SaveData"));atom.config.save()}h.dispose(),r&&r.destroy(),u&&u.destroy(),p&&p.destroy()};
//# sourceMappingURL=main.js.map
