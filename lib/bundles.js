"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const bundle_1 = require("./bundle");
const init_file_1 = require("./init-file");
const path_1 = __importDefault(require("path"));
const fs_1 = __importDefault(require("fs"));
const atom_1 = require("atom");
class Bundles {
    constructor(arg) {
        this.filename = null;
        this.data = {};
        this.single_bundles = {};
        this.project_bundles = {};
        this.writing = false;
        this.reload = this.reload.bind(this);
        this.setData = this.setData.bind(this);
        if (arg) {
            this.filename = arg === "" ? null : arg;
        }
        else {
            this.getFileName();
        }
        if (this.filename != null) {
            this.touchFile();
            this.getData();
            this.watcher = fs_1.default.watch(this.filename, this.reload);
        }
        else {
            this.data = {};
        }
        this.getPackages();
        this.project_bundles = {};
        this.emitter = new atom_1.Emitter();
    }
    destroy() {
        if (this.watcher != null) {
            this.watcher.close();
        }
        this.emitter.dispose();
        this.data = {};
        this.single_bundles = {};
        this.project_bundles = {};
    }
    reload(event, filename) {
        if (!this.writing) {
            if (this.filename != null) {
                this.getData();
            }
            this.emitter.emit("file-change");
        }
        else {
            this.writing = false;
        }
    }
    getFileName() {
        let configdir = atom.config.getUserConfigPath();
        if (!configdir) {
            configdir = atom.project.getPaths()[0];
        }
        this.filename = path_1.default.join(path_1.default.dirname(configdir), "package-switch.bundles");
    }
    onFileChange(callback) {
        this.emitter.on("file-change", callback);
    }
    getData() {
        try {
            const data = JSON.parse(fs_1.default.readFileSync(this.filename));
            Object.keys(data).forEach((key) => {
                this.data[key] = new bundle_1.Bundle(data[key]);
            });
        }
        catch (error) {
            this.notify("Error while reading settings from file");
            atom.notifications.addError(error);
        }
    }
    getPackages() {
        atom.packages.getAvailablePackageNames().forEach((name) => {
            this.single_bundles[name] = new bundle_1.Bundle({ packages: [{ name, action: "added" }] });
        });
    }
    setData(emit = true) {
        if (this.filename != null) {
            try {
                this.writing = true;
                fs_1.default.writeFileSync(this.filename, JSON.stringify(this.data, null, '\t'));
                if (emit) {
                    this.emitter.emit("file-change");
                }
            }
            catch (error) {
                this.notify(`Settings could not be written to ${this.filename}`);
                atom.notifications.addError(error);
            }
        }
        else {
            this.reload();
        }
    }
    notify(message) {
        if (atom.notifications != null) {
            atom.notifications.addError(message);
        }
        console.log("package-switch: " + message);
    }
    touchFile() {
        if (!fs_1.default.existsSync(this.filename)) {
            fs_1.default.writeFileSync(this.filename, "{}");
        }
    }
    addBundle(name, packages) {
        if (this.data[name] != null) {
            this.notify(`Bundle \"${name}\" already exists`);
        }
        else {
            this.data[name] = new bundle_1.Bundle({ packages });
            this.setData();
        }
    }
    replaceBundle(oldname, name, packages) {
        if ((oldname === name && this.data[oldname] != null) || (this.data[oldname] != null && this.data[name] == null)) {
            delete this.data[oldname];
            this.data[name] = new bundle_1.Bundle({ packages });
            this.setData();
        }
        else {
            if (!this.data[oldname]) {
                this.notify(`Bundle \"${oldname}\" not found`);
            }
            if (this.data[name] != null) {
                this.notify(`Bundle \"${name}\" already exists`);
            }
        }
    }
    removeBundle(bundle) {
        delete this.data[bundle];
        this.setData();
    }
    getBundle(bundle) {
        let _bundle;
        if ((_bundle = this.project_bundles[bundle]) != null) {
            return _bundle;
        }
        else if (this.data[bundle] != null) {
            return this.data[bundle];
        }
        else {
            return this.single_bundles[bundle];
        }
    }
    getBundles(singles = true) {
        const p = [];
        this.project_bundles = {};
        Object.keys(this.data).forEach((key) => {
            return p.push({
                name: key,
                packages: this.data[key].packages,
            });
        });
        if (!singles) {
            return p;
        }
        for (const project of atom.project.getPaths()) {
            const f = path_1.default.join(project, ".package-switch.json");
            if (fs_1.default.existsSync(f)) {
                let d, i;
                if ((i = new init_file_1.InitFile((d = path_1.default.basename(project)), f)).packages.length !== 0) {
                    p.push({
                        name: `Project: ${d}`,
                        packages: i.packages,
                    });
                    this.project_bundles[`Project: ${d}`] = i;
                }
            }
            else {
                const fcson = path_1.default.join(project, ".package-switch.json");
                if (fs_1.default.existsSync(fcson)) {
                    atom.notifications.addWarning(`Using CSON config for package-switch is deprecated. 
           Convert ${fcson} to JSON at https://decaffeinate-project.org/repl/`);
                    let d, i;
                    if ((i = new init_file_1.InitFileCSON((d = path_1.default.basename(project)), f)).packages.length !== 0) {
                        p.push({
                            name: `Project: ${d}`,
                            packages: i.packages,
                        });
                        this.project_bundles[`Project: ${d}`] = i;
                    }
                }
            }
        }
        Object.keys(this.single_bundles).forEach((key) => {
            if (this.data[key] == null) {
                return p.push({
                    name: key,
                    packages: this.single_bundles[key].packages,
                });
            }
        });
        return p;
    }
}
exports.Bundles = Bundles;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVuZGxlcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9idW5kbGVzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBS0EscUNBQWlDO0FBQ2pDLDJDQUFvRDtBQUVwRCxnREFBdUI7QUFDdkIsNENBQW1CO0FBQ25CLCtCQUE4QjtBQUU5QixNQUFhLE9BQU87SUFPbEIsWUFBWSxHQUFJO1FBTmhCLGFBQVEsR0FBRyxJQUFJLENBQUE7UUFDZixTQUFJLEdBQUcsRUFBRSxDQUFBO1FBQ1QsbUJBQWMsR0FBRyxFQUFFLENBQUE7UUFDbkIsb0JBQWUsR0FBRyxFQUFFLENBQUE7UUFDcEIsWUFBTyxHQUFHLEtBQUssQ0FBQTtRQUdiLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDcEMsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUN0QyxJQUFJLEdBQUcsRUFBRTtZQUNQLElBQUksQ0FBQyxRQUFRLEdBQUcsR0FBRyxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUE7U0FDeEM7YUFBTTtZQUNMLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQTtTQUNuQjtRQUNELElBQUksSUFBSSxDQUFDLFFBQVEsSUFBSSxJQUFJLEVBQUU7WUFDekIsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFBO1lBQ2hCLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQTtZQUNkLElBQUksQ0FBQyxPQUFPLEdBQUcsWUFBRSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQTtTQUNwRDthQUFNO1lBQ0wsSUFBSSxDQUFDLElBQUksR0FBRyxFQUFFLENBQUE7U0FDZjtRQUNELElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FB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SSxFQUFFO2dCQUMxQixPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUM7b0JBQ1osSUFBSSxFQUFFLEdBQUc7b0JBQ1QsUUFBUSxFQUFFLElBQUksQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLENBQUMsUUFBUTtpQkFDNUMsQ0FBQyxDQUFBO2FBQ0g7UUFDSCxDQUFDLENBQUMsQ0FBQTtRQUNGLE9BQU8sQ0FBQyxDQUFBO0lBQ1YsQ0FBQztDQUNGO0FBdk1ELDBCQXVNQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXHJcbiAqIGRlY2FmZmVpbmF0ZSBzdWdnZXN0aW9uczpcclxuICogRFMyMDc6IENvbnNpZGVyIHNob3J0ZXIgdmFyaWF0aW9ucyBvZiBudWxsIGNoZWNrc1xyXG4gKiBGdWxsIGRvY3M6IGh0dHBzOi8vZ2l0aHViLmNvbS9kZWNhZmZlaW5hdGUvZGVjYWZmZWluYXRlL2Jsb2IvbWFzdGVyL2RvY3Mvc3VnZ2VzdGlvbnMubWRcclxuICovXHJcbmltcG9ydCB7IEJ1bmRsZSB9IGZyb20gXCIuL2J1bmRsZVwiXHJcbmltcG9ydCB7IEluaXRGaWxlLCBJbml0RmlsZUNTT04gfSBmcm9tIFwiLi9pbml0LWZpbGVcIlxyXG5cclxuaW1wb3J0IHBhdGggZnJvbSBcInBhdGhcIlxyXG5pbXBvcnQgZnMgZnJvbSBcImZzXCJcclxuaW1wb3J0IHsgRW1pdHRlciB9IGZyb20gXCJhdG9tXCJcclxuXHJcbmV4cG9ydCBjbGFzcyBCdW5kbGVzIHtcclxuICBmaWxlbmFtZSA9IG51bGxcclxuICBkYXRhID0ge31cclxuICBzaW5nbGVfYnVuZGxlcyA9IHt9XHJcbiAgcHJvamVjdF9idW5kbGVzID0ge31cclxuICB3cml0aW5nID0gZmFsc2VcclxuXHJcbiAgY29uc3RydWN0b3IoYXJnPykge1xyXG4gICAgdGhpcy5yZWxvYWQgPSB0aGlzLnJlbG9hZC5iaW5kKHRoaXMpXHJcbiAgICB0aGlzLnNldERhdGEgPSB0aGlzLnNldERhdGEuYmluZCh0aGlzKVxyXG4gICAgaWYgKGFyZykge1xyXG4gICAgICB0aGlzLmZpbGVuYW1lID0gYXJnID09PSBcIlwiID8gbnVsbCA6IGFyZ1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5nZXRGaWxlTmFtZSgpXHJcbiAgICB9XHJcbiAgICBpZiAodGhpcy5maWxlbmFtZSAhPSBudWxsKSB7XHJcbiAgICAgIHRoaXMudG91Y2hGaWxlKClcclxuICAgICAgdGhpcy5nZXREYXRhKClcclxuICAgICAgdGhpcy53YXRjaGVyID0gZnMud2F0Y2godGhpcy5maWxlbmFtZSwgdGhpcy5yZWxvYWQpXHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLmRhdGEgPSB7fVxyXG4gICAgfVxyXG4gICAgdGhpcy5nZXRQYWNrYWdlcygpXHJcbiAgICB0aGlzLnByb2plY3RfYnVuZGxlcyA9IHt9XHJcbiAgICB0aGlzLmVtaXR0ZXIgPSBuZXcgRW1pdHRlcigpXHJcbiAgfVxyXG5cclxuICBkZXN0cm95KCkge1xyXG4gICAgaWYgKHRoaXMud2F0Y2hlciAhPSBudWxsKSB7XHJcbiAgICAgIHRoaXMud2F0Y2hlci5jbG9zZSgpXHJcbiAgICB9XHJcbiAgICB0aGlzLmVtaXR0ZXIuZGlzcG9zZSgpXHJcbiAgICB0aGlzLmRhdGEgPSB7fVxyXG4gICAgdGhpcy5zaW5nbGVfYnVuZGxlcyA9IHt9XHJcbiAgICB0aGlzLnByb2plY3RfYnVuZGxlcyA9IHt9XHJcbiAgfVxyXG5cclxuICByZWxvYWQoZXZlbnQ/LCBmaWxlbmFtZT8pIHtcclxuICAgIGlmICghdGhpcy53cml0aW5nKSB7XHJcbiAgICAgIGlmICh0aGlzLmZpbGVuYW1lICE9IG51bGwpIHtcclxuICAgICAgICB0aGlzLmdldERhdGEoKVxyXG4gICAgICB9XHJcbiAgICAgIHRoaXMuZW1pdHRlci5lbWl0KFwiZmlsZS1jaGFuZ2VcIilcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMud3JpdGluZyA9IGZhbHNlXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBnZXRGaWxlTmFtZSgpIHtcclxuICAgIGxldCBjb25maWdkaXIgPSBhdG9tLmNvbmZpZy5nZXRVc2VyQ29uZmlnUGF0aCgpXHJcbiAgICBpZiAoIWNvbmZpZ2Rpcikge1xyXG4gICAgICAvLyBUT0RPXHJcbiAgICAgIGNvbmZpZ2RpciA9IGF0b20ucHJvamVjdC5nZXRQYXRocygpWzBdXHJcbiAgICB9XHJcbiAgICB0aGlzLmZpbGVuYW1lID0gcGF0aC5qb2luKHBhdGguZGlybmFtZShjb25maWdkaXIpLCBcInBhY2thZ2Utc3dpdGNoLmJ1bmRsZXNcIilcclxuICB9XHJcblxyXG4gIG9uRmlsZUNoYW5nZShjYWxsYmFjaykge1xyXG4gICAgdGhpcy5lbWl0dGVyLm9uKFwiZmlsZS1jaGFuZ2VcIiwgY2FsbGJhY2spXHJcbiAgfVxyXG5cclxuICBnZXREYXRhKCkge1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgZGF0YSA9IEpTT04ucGFyc2UoZnMucmVhZEZpbGVTeW5jKHRoaXMuZmlsZW5hbWUpKVxyXG4gICAgICBPYmplY3Qua2V5cyhkYXRhKS5mb3JFYWNoKChrZXkpID0+IHtcclxuICAgICAgICB0aGlzLmRhdGFba2V5XSA9IG5ldyBCdW5kbGUoZGF0YVtrZXldKVxyXG4gICAgICB9KVxyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgdGhpcy5ub3RpZnkoXCJFcnJvciB3aGlsZSByZWFkaW5nIHNldHRpbmdzIGZyb20gZmlsZVwiKVxyXG4gICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkRXJyb3IoZXJyb3IpXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBnZXRQYWNrYWdlcygpIHtcclxuICAgIGF0b20ucGFja2FnZXMuZ2V0QXZhaWxhYmxlUGFja2FnZU5hbWVzKCkuZm9yRWFjaCgobmFtZSkgPT4ge1xyXG4gICAgICB0aGlzLnNpbmdsZV9idW5kbGVzW25hbWVdID0gbmV3IEJ1bmRsZSh7IHBhY2thZ2VzOiBbeyBuYW1lLCBhY3Rpb246IFwiYWRkZWRcIiB9XSB9KVxyXG4gICAgfSlcclxuICB9XHJcblxyXG4gIHNldERhdGEoZW1pdCA9IHRydWUpIHtcclxuICAgIGlmICh0aGlzLmZpbGVuYW1lICE9IG51bGwpIHtcclxuICAgICAgdHJ5IHtcclxuICAgICAgICB0aGlzLndyaXRpbmcgPSB0cnVlXHJcbiAgICAgICAgZnMud3JpdGVGaWxlU3luYyh0aGlzLmZpbGVuYW1lLCBKU09OLnN0cmluZ2lmeSh0aGlzLmRhdGEsIG51bGwsICdcXHQnKSlcclxuICAgICAgICBpZiAoZW1pdCkge1xyXG4gICAgICAgICAgdGhpcy5lbWl0dGVyLmVtaXQoXCJmaWxlLWNoYW5nZVwiKVxyXG4gICAgICAgIH1cclxuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICB0aGlzLm5vdGlmeShgU2V0dGluZ3MgY291bGQgbm90IGJlIHdyaXR0ZW4gdG8gJHt0aGlzLmZpbGVuYW1lfWApXHJcbiAgICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEVycm9yKGVycm9yKVxyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLnJlbG9hZCgpXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBub3RpZnkobWVzc2FnZT8pIHtcclxuICAgIGlmIChhdG9tLm5vdGlmaWNhdGlvbnMgIT0gbnVsbCkge1xyXG4gICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkRXJyb3IobWVzc2FnZSlcclxuICAgIH1cclxuICAgIGNvbnNvbGUubG9nKFwicGFja2FnZS1zd2l0Y2g6IFwiICsgbWVzc2FnZSlcclxuICB9XHJcblxyXG4gIHRvdWNoRmlsZSgpIHtcclxuICAgIGlmICghZnMuZXhpc3RzU3luYyh0aGlzLmZpbGVuYW1lKSkge1xyXG4gICAgICBmcy53cml0ZUZpbGVTeW5jKHRoaXMuZmlsZW5hbWUsIFwie31cIilcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGFkZEJ1bmRsZShuYW1lLCBwYWNrYWdlcykge1xyXG4gICAgaWYgKHRoaXMuZGF0YVtuYW1lXSAhPSBudWxsKSB7XHJcbiAgICAgIHRoaXMubm90aWZ5KGBCdW5kbGUgXFxcIiR7bmFtZX1cXFwiIGFscmVhZHkgZXhpc3RzYClcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMuZGF0YVtuYW1lXSA9IG5ldyBCdW5kbGUoeyBwYWNrYWdlcyB9KVxyXG4gICAgICB0aGlzLnNldERhdGEoKVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcmVwbGFjZUJ1bmRsZShvbGRuYW1lLCBuYW1lLCBwYWNrYWdlcykge1xyXG4gICAgaWYgKChvbGRuYW1lID09PSBuYW1lICYmIHRoaXMuZGF0YVtvbGRuYW1lXSAhPSBudWxsKSB8fCAodGhpcy5kYXRhW29sZG5hbWVdICE9IG51bGwgJiYgdGhpcy5kYXRhW25hbWVdID09IG51bGwpKSB7XHJcbiAgICAgIGRlbGV0ZSB0aGlzLmRhdGFbb2xkbmFtZV1cclxuICAgICAgdGhpcy5kYXRhW25hbWVdID0gbmV3IEJ1bmRsZSh7IHBhY2thZ2VzIH0pXHJcbiAgICAgIHRoaXMuc2V0RGF0YSgpXHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBpZiAoIXRoaXMuZGF0YVtvbGRuYW1lXSkge1xyXG4gICAgICAgIHRoaXMubm90aWZ5KGBCdW5kbGUgXFxcIiR7b2xkbmFtZX1cXFwiIG5vdCBmb3VuZGApXHJcbiAgICAgIH1cclxuICAgICAgaWYgKHRoaXMuZGF0YVtuYW1lXSAhPSBudWxsKSB7XHJcbiAgICAgICAgdGhpcy5ub3RpZnkoYEJ1bmRsZSBcXFwiJHtuYW1lfVxcXCIgYWxyZWFkeSBleGlzdHNgKVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICByZW1vdmVCdW5kbGUoYnVuZGxlKSB7XHJcbiAgICBkZWxldGUgdGhpcy5kYXRhW2J1bmRsZV1cclxuICAgIHRoaXMuc2V0RGF0YSgpXHJcbiAgfVxyXG5cclxuICBnZXRCdW5kbGUoYnVuZGxlKSB7XHJcbiAgICBsZXQgX2J1bmRsZVxyXG4gICAgaWYgKChfYnVuZGxlID0gdGhpcy5wcm9qZWN0X2J1bmRsZXNbYnVuZGxlXSkgIT0gbnVsbCkge1xyXG4gICAgICByZXR1cm4gX2J1bmRsZVxyXG4gICAgfSBlbHNlIGlmICh0aGlzLmRhdGFbYnVuZGxlXSAhPSBudWxsKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLmRhdGFbYnVuZGxlXVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIHRoaXMuc2luZ2xlX2J1bmRsZXNbYnVuZGxlXVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZ2V0QnVuZGxlcyhzaW5nbGVzID0gdHJ1ZSkge1xyXG4gICAgY29uc3QgcCA9IFtdXHJcbiAgICB0aGlzLnByb2plY3RfYnVuZGxlcyA9IHt9XHJcbiAgICBPYmplY3Qua2V5cyh0aGlzLmRhdGEpLmZvckVhY2goKGtleSkgPT4ge1xyXG4gICAgICByZXR1cm4gcC5wdXNoKHtcclxuICAgICAgICBuYW1lOiBrZXksXHJcbiAgICAgICAgcGFja2FnZXM6IHRoaXMuZGF0YVtrZXldLnBhY2thZ2VzLFxyXG4gICAgICB9KVxyXG4gICAgfSlcclxuICAgIGlmICghc2luZ2xlcykge1xyXG4gICAgICByZXR1cm4gcFxyXG4gICAgfVxyXG4gICAgZm9yIChjb25zdCBwcm9qZWN0IG9mIGF0b20ucHJvamVjdC5nZXRQYXRocygpKSB7XHJcbiAgICAgIGNvbnN0IGYgPSBwYXRoLmpvaW4ocHJvamVjdCwgXCIucGFja2FnZS1zd2l0Y2guanNvblwiKVxyXG4gICAgICBpZiAoZnMuZXhpc3RzU3luYyhmKSkge1xyXG4gICAgICAgIGxldCBkLCBpXHJcbiAgICAgICAgaWYgKChpID0gbmV3IEluaXRGaWxlKChkID0gcGF0aC5iYXNlbmFtZShwcm9qZWN0KSksIGYpKS5wYWNrYWdlcy5sZW5ndGggIT09IDApIHtcclxuICAgICAgICAgIHAucHVzaCh7XHJcbiAgICAgICAgICAgIG5hbWU6IGBQcm9qZWN0OiAke2R9YCxcclxuICAgICAgICAgICAgcGFja2FnZXM6IGkucGFja2FnZXMsXHJcbiAgICAgICAgICB9KVxyXG4gICAgICAgICAgdGhpcy5wcm9qZWN0X2J1bmRsZXNbYFByb2plY3Q6ICR7ZH1gXSA9IGlcclxuICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8gZGVwcmVjYXRlZFxyXG4gICAgICAgIGNvbnN0IGZjc29uID0gcGF0aC5qb2luKHByb2plY3QsIFwiLnBhY2thZ2Utc3dpdGNoLmpzb25cIilcclxuICAgICAgICBpZiAoZnMuZXhpc3RzU3luYyhmY3NvbikpIHtcclxuICAgICAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRXYXJuaW5nKGBVc2luZyBDU09OIGNvbmZpZyBmb3IgcGFja2FnZS1zd2l0Y2ggaXMgZGVwcmVjYXRlZC4gXHJcbiAgICAgICAgICAgQ29udmVydCAke2Zjc29ufSB0byBKU09OIGF0IGh0dHBzOi8vZGVjYWZmZWluYXRlLXByb2plY3Qub3JnL3JlcGwvYClcclxuICAgICAgICAgIGxldCBkLCBpXHJcbiAgICAgICAgICBpZiAoKGkgPSBuZXcgSW5pdEZpbGVDU09OKChkID0gcGF0aC5iYXNlbmFtZShwcm9qZWN0KSksIGYpKS5wYWNrYWdlcy5sZW5ndGggIT09IDApIHtcclxuICAgICAgICAgICAgcC5wdXNoKHtcclxuICAgICAgICAgICAgICBuYW1lOiBgUHJvamVjdDogJHtkfWAsXHJcbiAgICAgICAgICAgICAgcGFja2FnZXM6IGkucGFja2FnZXMsXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIHRoaXMucHJvamVjdF9idW5kbGVzW2BQcm9qZWN0OiAke2R9YF0gPSBpXHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBPYmplY3Qua2V5cyh0aGlzLnNpbmdsZV9idW5kbGVzKS5mb3JFYWNoKChrZXkpID0+IHtcclxuICAgICAgaWYgKHRoaXMuZGF0YVtrZXldID09IG51bGwpIHtcclxuICAgICAgICByZXR1cm4gcC5wdXNoKHtcclxuICAgICAgICAgIG5hbWU6IGtleSxcclxuICAgICAgICAgIHBhY2thZ2VzOiB0aGlzLnNpbmdsZV9idW5kbGVzW2tleV0ucGFja2FnZXMsXHJcbiAgICAgICAgfSlcclxuICAgICAgfVxyXG4gICAgfSlcclxuICAgIHJldHVybiBwXHJcbiAgfVxyXG59XHJcbiJdfQ==