"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const bundle_1 = require("./bundle");
const init_file_1 = require("./init-file");
const path_1 = __importDefault(require("path"));
const fs_1 = __importDefault(require("fs"));
const atom_1 = require("atom");
const season_1 = __importDefault(require("season"));
class Bundles {
    constructor(arg) {
        this.filename = null;
        this.data = {};
        this.single_bundles = {};
        this.project_bundles = {};
        this.writing = false;
        this.reload = this.reload.bind(this);
        this.setData = this.setData.bind(this);
        if (arg) {
            this.filename = arg === "" ? null : arg;
        }
        else {
            this.getFileName();
        }
        if (this.filename != null) {
            this.touchFile();
            this.getData();
            this.watcher = fs_1.default.watch(this.filename, this.reload);
        }
        else {
            this.data = {};
        }
        this.getPackages();
        this.project_bundles = {};
        this.emitter = new atom_1.Emitter();
    }
    destroy() {
        if (this.watcher != null) {
            this.watcher.close();
        }
        this.emitter.dispose();
        this.data = {};
        this.single_bundles = {};
        this.project_bundles = {};
    }
    reload(event, filename) {
        if (!this.writing) {
            if (this.filename != null) {
                this.getData();
            }
            this.emitter.emit("file-change");
        }
        else {
            this.writing = false;
        }
    }
    getFileName() {
        let configdir = atom.config.getUserConfigPath();
        if (!configdir) {
            configdir = atom.project.getPaths()[0];
        }
        this.filename = path_1.default.join(path_1.default.dirname(configdir), "package-switch.bundles");
    }
    onFileChange(callback) {
        this.emitter.on("file-change", callback);
    }
    getData() {
        try {
            const data = season_1.default.readFileSync(this.filename);
            Object.keys(data).forEach((key) => {
                this.data[key] = new bundle_1.Bundle(data[key]);
            });
        }
        catch (error) {
            this.notify("Error while reading settings from file");
        }
    }
    getPackages() {
        atom.packages.getAvailablePackageNames().forEach((name) => {
            this.single_bundles[name] = new bundle_1.Bundle({ packages: [{ name, action: "added" }] });
        });
    }
    setData(emit = true) {
        if (this.filename != null) {
            try {
                this.writing = true;
                season_1.default.writeFileSync(this.filename, this.data);
                if (emit) {
                    this.emitter.emit("file-change");
                }
            }
            catch (error) {
                this.notify(`Settings could not be written to ${this.filename}`);
            }
        }
        else {
            this.reload();
        }
    }
    notify(message) {
        if (atom.notifications != null) {
            atom.notifications.addError(message);
        }
        console.log("package-switch: " + message);
    }
    touchFile() {
        if (!fs_1.default.existsSync(this.filename)) {
            fs_1.default.writeFileSync(this.filename, "{}");
        }
    }
    addBundle(name, packages) {
        if (this.data[name] != null) {
            this.notify(`Bundle \"${name}\" already exists`);
        }
        else {
            this.data[name] = new bundle_1.Bundle({ packages });
            this.setData();
        }
    }
    replaceBundle(oldname, name, packages) {
        if ((oldname === name && this.data[oldname] != null) || (this.data[oldname] != null && this.data[name] == null)) {
            delete this.data[oldname];
            this.data[name] = new bundle_1.Bundle({ packages });
            this.setData();
        }
        else {
            if (!this.data[oldname]) {
                this.notify(`Bundle \"${oldname}\" not found`);
            }
            if (this.data[name] != null) {
                this.notify(`Bundle \"${name}\" already exists`);
            }
        }
    }
    removeBundle(bundle) {
        delete this.data[bundle];
        this.setData();
    }
    getBundle(bundle) {
        let _bundle;
        if ((_bundle = this.project_bundles[bundle]) != null) {
            return _bundle;
        }
        else if (this.data[bundle] != null) {
            return this.data[bundle];
        }
        else {
            return this.single_bundles[bundle];
        }
    }
    getBundles(singles = true) {
        const p = [];
        this.project_bundles = {};
        Object.keys(this.data).forEach((key) => {
            return p.push({
                name: key,
                packages: this.data[key].packages,
            });
        });
        if (!singles) {
            return p;
        }
        for (const project of atom.project.getPaths()) {
            let f;
            if (fs_1.default.existsSync((f = path_1.default.join(project, ".package-switch.cson")))) {
                let d, i;
                if ((i = new init_file_1.InitFile((d = path_1.default.basename(project)), f)).packages.length !== 0) {
                    p.push({
                        name: `Project: ${d}`,
                        packages: i.packages,
                    });
                    this.project_bundles[`Project: ${d}`] = i;
                }
            }
        }
        Object.keys(this.single_bundles).forEach((key) => {
            if (this.data[key] == null) {
                return p.push({
                    name: key,
                    packages: this.single_bundles[key].packages,
                });
            }
        });
        return p;
    }
}
exports.Bundles = Bundles;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVuZGxlcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9idW5kbGVzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBS0EscUNBQWlDO0FBQ2pDLDJDQUFzQztBQUV0QyxnREFBdUI7QUFDdkIsNENBQW1CO0FBQ25CLCtCQUE4QjtBQUM5QixvREFBeUI7QUFFekIsTUFBYSxPQUFPO0lBT2xCLFlBQVksR0FBSTtRQU5oQixhQUFRLEdBQUcsSUFBSSxDQUFBO1FBQ2YsU0FBSSxHQUFHLEVBQUUsQ0FBQTtRQUNULG1CQUFjLEdBQUcsRUFBRSxDQUFBO1FBQ25CLG9CQUFlLEdBQUcsRUFBRSxDQUFBO1FBQ3BCLFlBQU8sR0FBRyxLQUFLLENBQUE7UUFHYixJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQ3BDLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDdEMsSUFBSSxHQUFHLEVBQUU7WUFDUCxJQUFJLENBQUMsUUFBUSxHQUFHLEdBQUcsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFBO1NBQ3hDO2FBQU07WUFDTCxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUE7U0FDbkI7UUFDRCxJQUFJLElBQUksQ0FBQyxRQUFRLElBQUksSUFBSSxFQUFFO1lBQ3pCLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQTtZQUNoQixJQUFJLENBQUMsT0FBTyxFQUFFLENBQUE7WUFDZCxJQUFJLENBQUMsT0FBTyxHQUFHLFlBQUUsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUE7U0FDcEQ7YUFBTTtZQUNMLElBQUksQ0FBQyxJQUFJLEdBQUcsRUFBRSxDQUFBO1NBQ2Y7UUFDRCxJQUFJLENBQUMs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QUksQ0FBQyxlQUFlLENBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQTtpQkFDMUM7YUFDRjtTQUNGO1FBQ0QsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUU7WUFDL0MsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLElBQUksRUFBRTtnQkFDMUIsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDO29CQUNaLElBQUksRUFBRSxHQUFHO29CQUNULFFBQVEsRUFBRSxJQUFJLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxDQUFDLFFBQVE7aUJBQzVDLENBQUMsQ0FBQTthQUNIO1FBQ0gsQ0FBQyxDQUFDLENBQUE7UUFDRixPQUFPLENBQUMsQ0FBQTtJQUNWLENBQUM7Q0FDRjtBQXRMRCwwQkFzTEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogZGVjYWZmZWluYXRlIHN1Z2dlc3Rpb25zOlxuICogRFMyMDc6IENvbnNpZGVyIHNob3J0ZXIgdmFyaWF0aW9ucyBvZiBudWxsIGNoZWNrc1xuICogRnVsbCBkb2NzOiBodHRwczovL2dpdGh1Yi5jb20vZGVjYWZmZWluYXRlL2RlY2FmZmVpbmF0ZS9ibG9iL21hc3Rlci9kb2NzL3N1Z2dlc3Rpb25zLm1kXG4gKi9cbmltcG9ydCB7IEJ1bmRsZSB9IGZyb20gXCIuL2J1bmRsZVwiXG5pbXBvcnQgeyBJbml0RmlsZSB9IGZyb20gXCIuL2luaXQtZmlsZVwiXG5cbmltcG9ydCBwYXRoIGZyb20gXCJwYXRoXCJcbmltcG9ydCBmcyBmcm9tIFwiZnNcIlxuaW1wb3J0IHsgRW1pdHRlciB9IGZyb20gXCJhdG9tXCJcbmltcG9ydCBDU09OIGZyb20gXCJzZWFzb25cIlxuXG5leHBvcnQgY2xhc3MgQnVuZGxlcyB7XG4gIGZpbGVuYW1lID0gbnVsbFxuICBkYXRhID0ge31cbiAgc2luZ2xlX2J1bmRsZXMgPSB7fVxuICBwcm9qZWN0X2J1bmRsZXMgPSB7fVxuICB3cml0aW5nID0gZmFsc2VcblxuICBjb25zdHJ1Y3Rvcihhcmc/KSB7XG4gICAgdGhpcy5yZWxvYWQgPSB0aGlzLnJlbG9hZC5iaW5kKHRoaXMpXG4gICAgdGhpcy5zZXREYXRhID0gdGhpcy5zZXREYXRhLmJpbmQodGhpcylcbiAgICBpZiAoYXJnKSB7XG4gICAgICB0aGlzLmZpbGVuYW1lID0gYXJnID09PSBcIlwiID8gbnVsbCA6IGFyZ1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmdldEZpbGVOYW1lKClcbiAgICB9XG4gICAgaWYgKHRoaXMuZmlsZW5hbWUgIT0gbnVsbCkge1xuICAgICAgdGhpcy50b3VjaEZpbGUoKVxuICAgICAgdGhpcy5nZXREYXRhKClcbiAgICAgIHRoaXMud2F0Y2hlciA9IGZzLndhdGNoKHRoaXMuZmlsZW5hbWUsIHRoaXMucmVsb2FkKVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmRhdGEgPSB7fVxuICAgIH1cbiAgICB0aGlzLmdldFBhY2thZ2VzKClcbiAgICB0aGlzLnByb2plY3RfYnVuZGxlcyA9IHt9XG4gICAgdGhpcy5lbWl0dGVyID0gbmV3IEVtaXR0ZXIoKVxuICB9XG5cbiAgZGVzdHJveSgpIHtcbiAgICBpZiAodGhpcy53YXRjaGVyICE9IG51bGwpIHtcbiAgICAgIHRoaXMud2F0Y2hlci5jbG9zZSgpXG4gICAgfVxuICAgIHRoaXMuZW1pdHRlci5kaXNwb3NlKClcbiAgICB0aGlzLmRhdGEgPSB7fVxuICAgIHRoaXMuc2luZ2xlX2J1bmRsZXMgPSB7fVxuICAgIHRoaXMucHJvamVjdF9idW5kbGVzID0ge31cbiAgfVxuXG4gIHJlbG9hZChldmVudD8sIGZpbGVuYW1lPykge1xuICAgIGlmICghdGhpcy53cml0aW5nKSB7XG4gICAgICBpZiAodGhpcy5maWxlbmFtZSAhPSBudWxsKSB7XG4gICAgICAgIHRoaXMuZ2V0RGF0YSgpXG4gICAgICB9XG4gICAgICB0aGlzLmVtaXR0ZXIuZW1pdChcImZpbGUtY2hhbmdlXCIpXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMud3JpdGluZyA9IGZhbHNlXG4gICAgfVxuICB9XG5cbiAgZ2V0RmlsZU5hbWUoKSB7XG4gICAgbGV0IGNvbmZpZ2RpciA9IGF0b20uY29uZmlnLmdldFVzZXJDb25maWdQYXRoKClcbiAgICBpZiAoIWNvbmZpZ2Rpcikge1xuICAgICAgLy8gVE9ET1xuICAgICAgY29uZmlnZGlyID0gYXRvbS5wcm9qZWN0LmdldFBhdGhzKClbMF1cbiAgICB9XG4gICAgdGhpcy5maWxlbmFtZSA9IHBhdGguam9pbihwYXRoLmRpcm5hbWUoY29uZmlnZGlyKSwgXCJwYWNrYWdlLXN3aXRjaC5idW5kbGVzXCIpXG4gIH1cblxuICBvbkZpbGVDaGFuZ2UoY2FsbGJhY2spIHtcbiAgICB0aGlzLmVtaXR0ZXIub24oXCJmaWxlLWNoYW5nZVwiLCBjYWxsYmFjaylcbiAgfVxuXG4gIGdldERhdGEoKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGRhdGEgPSBDU09OLnJlYWRGaWxlU3luYyh0aGlzLmZpbGVuYW1lKVxuICAgICAgT2JqZWN0LmtleXMoZGF0YSkuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgICAgIHRoaXMuZGF0YVtrZXldID0gbmV3IEJ1bmRsZShkYXRhW2tleV0pXG4gICAgICB9KVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLm5vdGlmeShcIkVycm9yIHdoaWxlIHJlYWRpbmcgc2V0dGluZ3MgZnJvbSBmaWxlXCIpXG4gICAgfVxuICB9XG5cbiAgZ2V0UGFja2FnZXMoKSB7XG4gICAgYXRvbS5wYWNrYWdlcy5nZXRBdmFpbGFibGVQYWNrYWdlTmFtZXMoKS5mb3JFYWNoKChuYW1lKSA9PiB7XG4gICAgICB0aGlzLnNpbmdsZV9idW5kbGVzW25hbWVdID0gbmV3IEJ1bmRsZSh7IHBhY2thZ2VzOiBbeyBuYW1lLCBhY3Rpb246IFwiYWRkZWRcIiB9XSB9KVxuICAgIH0pXG4gIH1cblxuICBzZXREYXRhKGVtaXQgPSB0cnVlKSB7XG4gICAgaWYgKHRoaXMuZmlsZW5hbWUgIT0gbnVsbCkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgdGhpcy53cml0aW5nID0gdHJ1ZVxuICAgICAgICBDU09OLndyaXRlRmlsZVN5bmModGhpcy5maWxlbmFtZSwgdGhpcy5kYXRhKVxuICAgICAgICBpZiAoZW1pdCkge1xuICAgICAgICAgIHRoaXMuZW1pdHRlci5lbWl0KFwiZmlsZS1jaGFuZ2VcIilcbiAgICAgICAgfVxuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgdGhpcy5ub3RpZnkoYFNldHRpbmdzIGNvdWxkIG5vdCBiZSB3cml0dGVuIHRvICR7dGhpcy5maWxlbmFtZX1gKVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnJlbG9hZCgpXG4gICAgfVxuICB9XG5cbiAgbm90aWZ5KG1lc3NhZ2U/KSB7XG4gICAgaWYgKGF0b20ubm90aWZpY2F0aW9ucyAhPSBudWxsKSB7XG4gICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkRXJyb3IobWVzc2FnZSlcbiAgICB9XG4gICAgY29uc29sZS5sb2coXCJwYWNrYWdlLXN3aXRjaDogXCIgKyBtZXNzYWdlKVxuICB9XG5cbiAgdG91Y2hGaWxlKCkge1xuICAgIGlmICghZnMuZXhpc3RzU3luYyh0aGlzLmZpbGVuYW1lKSkge1xuICAgICAgZnMud3JpdGVGaWxlU3luYyh0aGlzLmZpbGVuYW1lLCBcInt9XCIpXG4gICAgfVxuICB9XG5cbiAgYWRkQnVuZGxlKG5hbWUsIHBhY2thZ2VzKSB7XG4gICAgaWYgKHRoaXMuZGF0YVtuYW1lXSAhPSBudWxsKSB7XG4gICAgICB0aGlzLm5vdGlmeShgQnVuZGxlIFxcXCIke25hbWV9XFxcIiBhbHJlYWR5IGV4aXN0c2ApXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZGF0YVtuYW1lXSA9IG5ldyBCdW5kbGUoeyBwYWNrYWdlcyB9KVxuICAgICAgdGhpcy5zZXREYXRhKClcbiAgICB9XG4gIH1cblxuICByZXBsYWNlQnVuZGxlKG9sZG5hbWUsIG5hbWUsIHBhY2thZ2VzKSB7XG4gICAgaWYgKChvbGRuYW1lID09PSBuYW1lICYmIHRoaXMuZGF0YVtvbGRuYW1lXSAhPSBudWxsKSB8fCAodGhpcy5kYXRhW29sZG5hbWVdICE9IG51bGwgJiYgdGhpcy5kYXRhW25hbWVdID09IG51bGwpKSB7XG4gICAgICBkZWxldGUgdGhpcy5kYXRhW29sZG5hbWVdXG4gICAgICB0aGlzLmRhdGFbbmFtZV0gPSBuZXcgQnVuZGxlKHsgcGFja2FnZXMgfSlcbiAgICAgIHRoaXMuc2V0RGF0YSgpXG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICghdGhpcy5kYXRhW29sZG5hbWVdKSB7XG4gICAgICAgIHRoaXMubm90aWZ5KGBCdW5kbGUgXFxcIiR7b2xkbmFtZX1cXFwiIG5vdCBmb3VuZGApXG4gICAgICB9XG4gICAgICBpZiAodGhpcy5kYXRhW25hbWVdICE9IG51bGwpIHtcbiAgICAgICAgdGhpcy5ub3RpZnkoYEJ1bmRsZSBcXFwiJHtuYW1lfVxcXCIgYWxyZWFkeSBleGlzdHNgKVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHJlbW92ZUJ1bmRsZShidW5kbGUpIHtcbiAgICBkZWxldGUgdGhpcy5kYXRhW2J1bmRsZV1cbiAgICB0aGlzLnNldERhdGEoKVxuICB9XG5cbiAgZ2V0QnVuZGxlKGJ1bmRsZSkge1xuICAgIGxldCBfYnVuZGxlXG4gICAgaWYgKChfYnVuZGxlID0gdGhpcy5wcm9qZWN0X2J1bmRsZXNbYnVuZGxlXSkgIT0gbnVsbCkge1xuICAgICAgcmV0dXJuIF9idW5kbGVcbiAgICB9IGVsc2UgaWYgKHRoaXMuZGF0YVtidW5kbGVdICE9IG51bGwpIHtcbiAgICAgIHJldHVybiB0aGlzLmRhdGFbYnVuZGxlXVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy5zaW5nbGVfYnVuZGxlc1tidW5kbGVdXG4gICAgfVxuICB9XG5cbiAgZ2V0QnVuZGxlcyhzaW5nbGVzID0gdHJ1ZSkge1xuICAgIGNvbnN0IHAgPSBbXVxuICAgIHRoaXMucHJvamVjdF9idW5kbGVzID0ge31cbiAgICBPYmplY3Qua2V5cyh0aGlzLmRhdGEpLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgcmV0dXJuIHAucHVzaCh7XG4gICAgICAgIG5hbWU6IGtleSxcbiAgICAgICAgcGFja2FnZXM6IHRoaXMuZGF0YVtrZXldLnBhY2thZ2VzLFxuICAgICAgfSlcbiAgICB9KVxuICAgIGlmICghc2luZ2xlcykge1xuICAgICAgcmV0dXJuIHBcbiAgICB9XG4gICAgZm9yIChjb25zdCBwcm9qZWN0IG9mIGF0b20ucHJvamVjdC5nZXRQYXRocygpKSB7XG4gICAgICBsZXQgZlxuICAgICAgaWYgKGZzLmV4aXN0c1N5bmMoKGYgPSBwYXRoLmpvaW4ocHJvamVjdCwgXCIucGFja2FnZS1zd2l0Y2guY3NvblwiKSkpKSB7XG4gICAgICAgIGxldCBkLCBpXG4gICAgICAgIGlmICgoaSA9IG5ldyBJbml0RmlsZSgoZCA9IHBhdGguYmFzZW5hbWUocHJvamVjdCkpLCBmKSkucGFja2FnZXMubGVuZ3RoICE9PSAwKSB7XG4gICAgICAgICAgcC5wdXNoKHtcbiAgICAgICAgICAgIG5hbWU6IGBQcm9qZWN0OiAke2R9YCxcbiAgICAgICAgICAgIHBhY2thZ2VzOiBpLnBhY2thZ2VzLFxuICAgICAgICAgIH0pXG4gICAgICAgICAgdGhpcy5wcm9qZWN0X2J1bmRsZXNbYFByb2plY3Q6ICR7ZH1gXSA9IGlcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBPYmplY3Qua2V5cyh0aGlzLnNpbmdsZV9idW5kbGVzKS5mb3JFYWNoKChrZXkpID0+IHtcbiAgICAgIGlmICh0aGlzLmRhdGFba2V5XSA9PSBudWxsKSB7XG4gICAgICAgIHJldHVybiBwLnB1c2goe1xuICAgICAgICAgIG5hbWU6IGtleSxcbiAgICAgICAgICBwYWNrYWdlczogdGhpcy5zaW5nbGVfYnVuZGxlc1trZXldLnBhY2thZ2VzLFxuICAgICAgICB9KVxuICAgICAgfVxuICAgIH0pXG4gICAgcmV0dXJuIHBcbiAgfVxufVxuIl19