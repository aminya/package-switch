"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const bundle_1 = require("./bundle");
const init_file_1 = require("./init-file");
const path_1 = __importDefault(require("path"));
const fs_1 = __importDefault(require("fs"));
const atom_1 = require("atom");
const season_1 = __importDefault(require("season"));
class Bundles {
    constructor(arg) {
        this.filename = null;
        this.data = {};
        this.single_bundles = {};
        this.project_bundles = {};
        this.writing = false;
        this.reload = this.reload.bind(this);
        this.setData = this.setData.bind(this);
        if (arg) {
            this.filename = arg === "" ? null : arg;
        }
        else {
            this.getFileName();
        }
        if (this.filename != null) {
            this.touchFile();
            this.getData();
            this.watcher = fs_1.default.watch(this.filename, this.reload);
        }
        else {
            this.data = {};
        }
        this.getPackages();
        this.project_bundles = {};
        this.emitter = new atom_1.Emitter();
    }
    destroy() {
        if (this.watcher != null) {
            this.watcher.close();
        }
        this.emitter.dispose();
        this.data = {};
        this.single_bundles = {};
        this.project_bundles = {};
    }
    reload(event, filename) {
        if (!this.writing) {
            if (this.filename != null) {
                this.getData();
            }
            this.emitter.emit("file-change");
        }
        else {
            this.writing = false;
        }
    }
    getFileName() {
        let configdir = atom.config.getUserConfigPath();
        if (!configdir) {
            configdir = atom.project.getPaths()[0];
        }
        this.filename = path_1.default.join(path_1.default.dirname(configdir), "package-switch.bundles");
    }
    onFileChange(callback) {
        this.emitter.on("file-change", callback);
    }
    getData() {
        try {
            const data = season_1.default.readFileSync(this.filename);
            Object.keys(data).forEach((key) => {
                this.data[key] = new bundle_1.Bundle(data[key]);
            });
        }
        catch (error) {
            this.notify("Error while reading settings from file");
        }
    }
    getPackages() {
        atom.packages.getAvailablePackageNames().forEach((name) => {
            this.single_bundles[name] = new bundle_1.Bundle({ packages: [{ name, action: "added" }] });
        });
    }
    setData(emit = true) {
        if (this.filename != null) {
            try {
                this.writing = true;
                season_1.default.writeFileSync(this.filename, this.data);
                if (emit) {
                    this.emitter.emit("file-change");
                }
            }
            catch (error) {
                this.notify(`Settings could not be written to ${this.filename}`);
            }
        }
        else {
            this.reload();
        }
    }
    notify(message) {
        if (atom.notifications != null) {
            atom.notifications.addError(message);
        }
        console.log("package-switch: " + message);
    }
    touchFile() {
        if (!fs_1.default.existsSync(this.filename)) {
            fs_1.default.writeFileSync(this.filename, "{}");
        }
    }
    addBundle(name, packages) {
        if (this.data[name] != null) {
            this.notify(`Bundle \"${name}\" already exists`);
        }
        else {
            this.data[name] = new bundle_1.Bundle({ packages });
            this.setData();
        }
    }
    replaceBundle(oldname, name, packages) {
        if ((oldname === name && this.data[oldname] != null) || (this.data[oldname] != null && this.data[name] == null)) {
            delete this.data[oldname];
            this.data[name] = new bundle_1.Bundle({ packages });
            this.setData();
        }
        else {
            if (!this.data[oldname]) {
                this.notify(`Bundle \"${oldname}\" not found`);
            }
            if (this.data[name] != null) {
                this.notify(`Bundle \"${name}\" already exists`);
            }
        }
    }
    removeBundle(bundle) {
        delete this.data[bundle];
        this.setData();
    }
    getBundle(bundle) {
        let _bundle;
        if ((_bundle = this.project_bundles[bundle]) != null) {
            return _bundle;
        }
        else if (this.data[bundle] != null) {
            return this.data[bundle];
        }
        else {
            return this.single_bundles[bundle];
        }
    }
    getBundles(singles = true) {
        const p = [];
        this.project_bundles = {};
        Object.keys(this.data).forEach((key) => {
            return p.push({
                name: key,
                packages: this.data[key].packages,
            });
        });
        if (!singles) {
            return p;
        }
        for (const project of atom.project.getPaths()) {
            let f;
            if (fs_1.default.existsSync((f = path_1.default.join(project, ".package-switch.cson")))) {
                let d, i;
                if ((i = new init_file_1.InitFile((d = path_1.default.basename(project)), f)).packages.length !== 0) {
                    p.push({
                        name: `Project: ${d}`,
                        packages: i.packages,
                    });
                    this.project_bundles[`Project: ${d}`] = i;
                }
            }
        }
        Object.keys(this.single_bundles).forEach((key) => {
            if (this.data[key] == null) {
                return p.push({
                    name: key,
                    packages: this.single_bundles[key].packages,
                });
            }
        });
        return p;
    }
}
exports.Bundles = Bundles;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVuZGxlcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9idW5kbGVzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBS0EscUNBQWlDO0FBQ2pDLDJDQUFzQztBQUV0QyxnREFBdUI7QUFDdkIsNENBQW1CO0FBQ25CLCtCQUE4QjtBQUM5QixvREFBeUI7QUFFekIsTUFBYSxPQUFPO0lBT2xCLFlBQVksR0FBSTtRQU5oQixhQUFRLEdBQUcsSUFBSSxDQUFBO1FBQ2YsU0FBSSxHQUFHLEVBQUUsQ0FBQTtRQUNULG1CQUFjLEdBQUcsRUFBRSxDQUFBO1FBQ25CLG9CQUFlLEdBQUcsRUFBRSxDQUFBO1FBQ3BCLFlBQU8sR0FBRyxLQUFLLENBQUE7UUFHYixJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQ3BDLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDdEMsSUFBSSxHQUFHLEVBQUU7WUFDUCxJQUFJLENBQUMsUUFBUSxHQUFHLEdBQUcsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFBO1NBQ3hDO2FBQU07WUFDTCxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUE7U0FDbkI7UUFDRCxJQUFJLElBQUksQ0FBQyxRQUFRLElBQUksSUFBSSxFQUFFO1lBQ3pCLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQTtZQUNoQixJQUFJLENBQUMsT0FBTyxFQUFFLENBQUE7WUFDZCxJQUFJLENBQUMsT0FBTyxHQUFHLFlBQUUsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUE7U0FDcEQ7YUFBTTtZQUNMLElBQUksQ0FBQyxJQUFJLEdBQUcsRUFBRSxDQUFBO1NBQ2Y7UUFDRCxJQUFJLENBQUMs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QUksQ0FBQyxlQUFlLENBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQTtpQkFDMUM7YUFDRjtTQUNGO1FBQ0QsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUU7WUFDL0MsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLElBQUksRUFBRTtnQkFDMUIsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDO29CQUNaLElBQUksRUFBRSxHQUFHO29CQUNULFFBQVEsRUFBRSxJQUFJLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxDQUFDLFFBQVE7aUJBQzVDLENBQUMsQ0FBQTthQUNIO1FBQ0gsQ0FBQyxDQUFDLENBQUE7UUFDRixPQUFPLENBQUMsQ0FBQTtJQUNWLENBQUM7Q0FDRjtBQXJMRCwwQkFxTEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxyXG4gKiBkZWNhZmZlaW5hdGUgc3VnZ2VzdGlvbnM6XHJcbiAqIERTMjA3OiBDb25zaWRlciBzaG9ydGVyIHZhcmlhdGlvbnMgb2YgbnVsbCBjaGVja3NcclxuICogRnVsbCBkb2NzOiBodHRwczovL2dpdGh1Yi5jb20vZGVjYWZmZWluYXRlL2RlY2FmZmVpbmF0ZS9ibG9iL21hc3Rlci9kb2NzL3N1Z2dlc3Rpb25zLm1kXHJcbiAqL1xyXG5pbXBvcnQgeyBCdW5kbGUgfSBmcm9tIFwiLi9idW5kbGVcIlxyXG5pbXBvcnQgeyBJbml0RmlsZSB9IGZyb20gXCIuL2luaXQtZmlsZVwiXHJcblxyXG5pbXBvcnQgcGF0aCBmcm9tIFwicGF0aFwiXHJcbmltcG9ydCBmcyBmcm9tIFwiZnNcIlxyXG5pbXBvcnQgeyBFbWl0dGVyIH0gZnJvbSBcImF0b21cIlxyXG5pbXBvcnQgQ1NPTiBmcm9tIFwic2Vhc29uXCJcclxuXHJcbmV4cG9ydCBjbGFzcyBCdW5kbGVzIHtcclxuICBmaWxlbmFtZSA9IG51bGxcclxuICBkYXRhID0ge31cclxuICBzaW5nbGVfYnVuZGxlcyA9IHt9XHJcbiAgcHJvamVjdF9idW5kbGVzID0ge31cclxuICB3cml0aW5nID0gZmFsc2VcclxuXHJcbiAgY29uc3RydWN0b3IoYXJnPykge1xyXG4gICAgdGhpcy5yZWxvYWQgPSB0aGlzLnJlbG9hZC5iaW5kKHRoaXMpXHJcbiAgICB0aGlzLnNldERhdGEgPSB0aGlzLnNldERhdGEuYmluZCh0aGlzKVxyXG4gICAgaWYgKGFyZykge1xyXG4gICAgICB0aGlzLmZpbGVuYW1lID0gYXJnID09PSBcIlwiID8gbnVsbCA6IGFyZ1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5nZXRGaWxlTmFtZSgpXHJcbiAgICB9XHJcbiAgICBpZiAodGhpcy5maWxlbmFtZSAhPSBudWxsKSB7XHJcbiAgICAgIHRoaXMudG91Y2hGaWxlKClcclxuICAgICAgdGhpcy5nZXREYXRhKClcclxuICAgICAgdGhpcy53YXRjaGVyID0gZnMud2F0Y2godGhpcy5maWxlbmFtZSwgdGhpcy5yZWxvYWQpXHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLmRhdGEgPSB7fVxyXG4gICAgfVxyXG4gICAgdGhpcy5nZXRQYWNrYWdlcygpXHJcbiAgICB0aGlzLnByb2plY3RfYnVuZGxlcyA9IHt9XHJcbiAgICB0aGlzLmVtaXR0ZXIgPSBuZXcgRW1pdHRlcigpXHJcbiAgfVxyXG5cclxuICBkZXN0cm95KCkge1xyXG4gICAgaWYgKHRoaXMud2F0Y2hlciAhPSBudWxsKSB7XHJcbiAgICAgIHRoaXMud2F0Y2hlci5jbG9zZSgpXHJcbiAgICB9XHJcbiAgICB0aGlzLmVtaXR0ZXIuZGlzcG9zZSgpXHJcbiAgICB0aGlzLmRhdGEgPSB7fVxyXG4gICAgdGhpcy5zaW5nbGVfYnVuZGxlcyA9IHt9XHJcbiAgICB0aGlzLnByb2plY3RfYnVuZGxlcyA9IHt9XHJcbiAgfVxyXG5cclxuICByZWxvYWQoZXZlbnQ/LCBmaWxlbmFtZT8pIHtcclxuICAgIGlmICghdGhpcy53cml0aW5nKSB7XHJcbiAgICAgIGlmICh0aGlzLmZpbGVuYW1lICE9IG51bGwpIHtcclxuICAgICAgICB0aGlzLmdldERhdGEoKVxyXG4gICAgICB9XHJcbiAgICAgIHRoaXMuZW1pdHRlci5lbWl0KFwiZmlsZS1jaGFuZ2VcIilcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMud3JpdGluZyA9IGZhbHNlXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBnZXRGaWxlTmFtZSgpIHtcclxuICAgIGxldCBjb25maWdkaXIgPSBhdG9tLmNvbmZpZy5nZXRVc2VyQ29uZmlnUGF0aCgpXHJcbiAgICBpZiAoIWNvbmZpZ2RpcikgeyAvLyBUT0RPXHJcbiAgICAgIGNvbmZpZ2RpciA9IGF0b20ucHJvamVjdC5nZXRQYXRocygpWzBdXHJcbiAgICB9XHJcbiAgICB0aGlzLmZpbGVuYW1lID0gcGF0aC5qb2luKHBhdGguZGlybmFtZShjb25maWdkaXIpLCBcInBhY2thZ2Utc3dpdGNoLmJ1bmRsZXNcIilcclxuICB9XHJcblxyXG4gIG9uRmlsZUNoYW5nZShjYWxsYmFjaykge1xyXG4gICAgdGhpcy5lbWl0dGVyLm9uKFwiZmlsZS1jaGFuZ2VcIiwgY2FsbGJhY2spXHJcbiAgfVxyXG5cclxuICBnZXREYXRhKCkge1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgZGF0YSA9IENTT04ucmVhZEZpbGVTeW5jKHRoaXMuZmlsZW5hbWUpXHJcbiAgICAgIE9iamVjdC5rZXlzKGRhdGEpLmZvckVhY2goKGtleSkgPT4ge1xyXG4gICAgICAgIHRoaXMuZGF0YVtrZXldID0gbmV3IEJ1bmRsZShkYXRhW2tleV0pXHJcbiAgICAgIH0pXHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICB0aGlzLm5vdGlmeShcIkVycm9yIHdoaWxlIHJlYWRpbmcgc2V0dGluZ3MgZnJvbSBmaWxlXCIpXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBnZXRQYWNrYWdlcygpIHtcclxuICAgIGF0b20ucGFja2FnZXMuZ2V0QXZhaWxhYmxlUGFja2FnZU5hbWVzKCkuZm9yRWFjaCgobmFtZSkgPT4ge1xyXG4gICAgICB0aGlzLnNpbmdsZV9idW5kbGVzW25hbWVdID0gbmV3IEJ1bmRsZSh7IHBhY2thZ2VzOiBbeyBuYW1lLCBhY3Rpb246IFwiYWRkZWRcIiB9XSB9KVxyXG4gICAgfSlcclxuICB9XHJcblxyXG4gIHNldERhdGEoZW1pdCA9IHRydWUpIHtcclxuICAgIGlmICh0aGlzLmZpbGVuYW1lICE9IG51bGwpIHtcclxuICAgICAgdHJ5IHtcclxuICAgICAgICB0aGlzLndyaXRpbmcgPSB0cnVlXHJcbiAgICAgICAgQ1NPTi53cml0ZUZpbGVTeW5jKHRoaXMuZmlsZW5hbWUsIHRoaXMuZGF0YSlcclxuICAgICAgICBpZiAoZW1pdCkge1xyXG4gICAgICAgICAgdGhpcy5lbWl0dGVyLmVtaXQoXCJmaWxlLWNoYW5nZVwiKVxyXG4gICAgICAgIH1cclxuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICB0aGlzLm5vdGlmeShgU2V0dGluZ3MgY291bGQgbm90IGJlIHdyaXR0ZW4gdG8gJHt0aGlzLmZpbGVuYW1lfWApXHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMucmVsb2FkKClcclxuICAgIH1cclxuICB9XHJcblxyXG4gIG5vdGlmeShtZXNzYWdlPykge1xyXG4gICAgaWYgKGF0b20ubm90aWZpY2F0aW9ucyAhPSBudWxsKSB7XHJcbiAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRFcnJvcihtZXNzYWdlKVxyXG4gICAgfVxyXG4gICAgY29uc29sZS5sb2coXCJwYWNrYWdlLXN3aXRjaDogXCIgKyBtZXNzYWdlKVxyXG4gIH1cclxuXHJcbiAgdG91Y2hGaWxlKCkge1xyXG4gICAgaWYgKCFmcy5leGlzdHNTeW5jKHRoaXMuZmlsZW5hbWUpKSB7XHJcbiAgICAgIGZzLndyaXRlRmlsZVN5bmModGhpcy5maWxlbmFtZSwgXCJ7fVwiKVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgYWRkQnVuZGxlKG5hbWUsIHBhY2thZ2VzKSB7XHJcbiAgICBpZiAodGhpcy5kYXRhW25hbWVdICE9IG51bGwpIHtcclxuICAgICAgdGhpcy5ub3RpZnkoYEJ1bmRsZSBcXFwiJHtuYW1lfVxcXCIgYWxyZWFkeSBleGlzdHNgKVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5kYXRhW25hbWVdID0gbmV3IEJ1bmRsZSh7IHBhY2thZ2VzIH0pXHJcbiAgICAgIHRoaXMuc2V0RGF0YSgpXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICByZXBsYWNlQnVuZGxlKG9sZG5hbWUsIG5hbWUsIHBhY2thZ2VzKSB7XHJcbiAgICBpZiAoKG9sZG5hbWUgPT09IG5hbWUgJiYgdGhpcy5kYXRhW29sZG5hbWVdICE9IG51bGwpIHx8ICh0aGlzLmRhdGFbb2xkbmFtZV0gIT0gbnVsbCAmJiB0aGlzLmRhdGFbbmFtZV0gPT0gbnVsbCkpIHtcclxuICAgICAgZGVsZXRlIHRoaXMuZGF0YVtvbGRuYW1lXVxyXG4gICAgICB0aGlzLmRhdGFbbmFtZV0gPSBuZXcgQnVuZGxlKHsgcGFja2FnZXMgfSlcclxuICAgICAgdGhpcy5zZXREYXRhKClcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGlmICghdGhpcy5kYXRhW29sZG5hbWVdKSB7XHJcbiAgICAgICAgdGhpcy5ub3RpZnkoYEJ1bmRsZSBcXFwiJHtvbGRuYW1lfVxcXCIgbm90IGZvdW5kYClcclxuICAgICAgfVxyXG4gICAgICBpZiAodGhpcy5kYXRhW25hbWVdICE9IG51bGwpIHtcclxuICAgICAgICB0aGlzLm5vdGlmeShgQnVuZGxlIFxcXCIke25hbWV9XFxcIiBhbHJlYWR5IGV4aXN0c2ApXHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIHJlbW92ZUJ1bmRsZShidW5kbGUpIHtcclxuICAgIGRlbGV0ZSB0aGlzLmRhdGFbYnVuZGxlXVxyXG4gICAgdGhpcy5zZXREYXRhKClcclxuICB9XHJcblxyXG4gIGdldEJ1bmRsZShidW5kbGUpIHtcclxuICAgIGxldCBfYnVuZGxlXHJcbiAgICBpZiAoKF9idW5kbGUgPSB0aGlzLnByb2plY3RfYnVuZGxlc1tidW5kbGVdKSAhPSBudWxsKSB7XHJcbiAgICAgIHJldHVybiBfYnVuZGxlXHJcbiAgICB9IGVsc2UgaWYgKHRoaXMuZGF0YVtidW5kbGVdICE9IG51bGwpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuZGF0YVtidW5kbGVdXHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gdGhpcy5zaW5nbGVfYnVuZGxlc1tidW5kbGVdXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBnZXRCdW5kbGVzKHNpbmdsZXMgPSB0cnVlKSB7XHJcbiAgICBjb25zdCBwID0gW11cclxuICAgIHRoaXMucHJvamVjdF9idW5kbGVzID0ge31cclxuICAgIE9iamVjdC5rZXlzKHRoaXMuZGF0YSkuZm9yRWFjaCgoa2V5KSA9PiB7XHJcbiAgICAgIHJldHVybiBwLnB1c2goe1xyXG4gICAgICAgIG5hbWU6IGtleSxcclxuICAgICAgICBwYWNrYWdlczogdGhpcy5kYXRhW2tleV0ucGFja2FnZXMsXHJcbiAgICAgIH0pXHJcbiAgICB9KVxyXG4gICAgaWYgKCFzaW5nbGVzKSB7XHJcbiAgICAgIHJldHVybiBwXHJcbiAgICB9XHJcbiAgICBmb3IgKGNvbnN0IHByb2plY3Qgb2YgYXRvbS5wcm9qZWN0LmdldFBhdGhzKCkpIHtcclxuICAgICAgbGV0IGZcclxuICAgICAgaWYgKGZzLmV4aXN0c1N5bmMoKGYgPSBwYXRoLmpvaW4ocHJvamVjdCwgXCIucGFja2FnZS1zd2l0Y2guY3NvblwiKSkpKSB7XHJcbiAgICAgICAgbGV0IGQsIGlcclxuICAgICAgICBpZiAoKGkgPSBuZXcgSW5pdEZpbGUoKGQgPSBwYXRoLmJhc2VuYW1lKHByb2plY3QpKSwgZikpLnBhY2thZ2VzLmxlbmd0aCAhPT0gMCkge1xyXG4gICAgICAgICAgcC5wdXNoKHtcclxuICAgICAgICAgICAgbmFtZTogYFByb2plY3Q6ICR7ZH1gLFxyXG4gICAgICAgICAgICBwYWNrYWdlczogaS5wYWNrYWdlcyxcclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgICB0aGlzLnByb2plY3RfYnVuZGxlc1tgUHJvamVjdDogJHtkfWBdID0gaVxyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgT2JqZWN0LmtleXModGhpcy5zaW5nbGVfYnVuZGxlcykuZm9yRWFjaCgoa2V5KSA9PiB7XHJcbiAgICAgIGlmICh0aGlzLmRhdGFba2V5XSA9PSBudWxsKSB7XHJcbiAgICAgICAgcmV0dXJuIHAucHVzaCh7XHJcbiAgICAgICAgICBuYW1lOiBrZXksXHJcbiAgICAgICAgICBwYWNrYWdlczogdGhpcy5zaW5nbGVfYnVuZGxlc1trZXldLnBhY2thZ2VzLFxyXG4gICAgICAgIH0pXHJcbiAgICAgIH1cclxuICAgIH0pXHJcbiAgICByZXR1cm4gcFxyXG4gIH1cclxufVxyXG4iXX0=